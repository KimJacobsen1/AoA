<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Age of Adventure – Character, Companion & Hireling Tools</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500&family=EB+Garamond&display=swap" rel="stylesheet">
<style>
  :root{--ink:#2c2c2c;--paper:#f4f0e6;--panel:#fffdf9;--sheet:#fffef9;--gold:#b8a97f;--head:#3a2c1a;--warn:#9b1c1c}
  *{box-sizing:border-box}
  body{font-family:"EB Garamond",serif;background:var(--paper);margin:0;padding:20px;color:var(--ink)}
  h1{font-family:"Cinzel",serif;text-align:center;font-size:2.4em;margin:8px 0 18px;color:var(--head)}
  h2{font-family:"Cinzel",serif;color:var(--head);border-bottom:1px solid var(--gold);padding-bottom:4px;margin:6px 0 12px}
  h3,h4{font-family:"Cinzel",serif;margin:8px 0}
  .step,.panel{border:2px solid var(--gold);padding:18px;margin:18px auto;border-radius:10px;background:var(--panel);max-width:980px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
  .sheet{border:2px solid var(--gold);padding:16px 18px;margin:22px auto;border-radius:12px;background:var(--sheet);max-width:820px;box-shadow:0 6px 18px rgba(0,0,0,.12)}
  .sheet h2{text-align:center;margin-bottom:10px}
  .section{margin:10px 0 16px}
  .section h4{margin:0 0 6px;font-size:1.05em;color:var(--head)}
  .hr{height:1px;background:var(--gold);opacity:.85;border:0;margin:10px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .grow{flex:1 1 260px}
  input,textarea,select{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;font:inherit;margin:6px 0}
  textarea{min-height:80px}
  ul{margin:0;padding-left:20px}
  li{margin:2px 0}
  .btn{margin:6px 4px;padding:10px 14px;border:0;border-radius:6px;font:inherit;font-weight:700;cursor:pointer;transition:transform .15s,background .25s}
  .next-btn{background:#6a5234;color:#fff}.next-btn:hover{background:#856947;transform:scale(1.05)}
  .link-btn{background:#27568c;color:#fff}.link-btn:hover{background:#2f6dad;transform:scale(1.05)}
  .print-btn{background:#2f6d3f;color:#fff}.print-btn:hover{background:#3f8a55;transform:scale(1.05)}
  .reset-btn{background:#7d2f2f;color:#fff}.reset-btn:hover{background:#a14444;transform:scale(1.05)}
  .buy-btn{background:#8b7355;color:#fff;padding:6px 10px;margin:3px;font-size:.92em}.buy-btn:hover{background:#a18767;transform:scale(1.05)}
  .choice-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:14px}
  .choice-card{border:2px solid var(--gold);border-radius:12px;background:#fffefb;padding:18px;text-align:center}
  .avatar{width:140px;height:140px;border:2px solid var(--gold);border-radius:10px;object-fit:cover;background:#eee}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .tools-grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
  .muted{color:#6d5b3f;font-style:italic}
  .warn{color:var(--warn);font-weight:700}
  .hidden{display:none !important}
  @media print{
    body{background:#fff}
    body *{visibility:hidden !important;height:0 !important}
    .printing,.printing *{visibility:visible !important;height:auto !important}
    .printing{position:absolute;left:0;top:0;width:100%;margin:0;border:0;box-shadow:none}
  }
</style>
</head>
<body>

<h1>Age of Adventure – Tools by Nylo</h1>

<!-- HOME -->
<div class="panel" id="home">
  <h2>What would you like to do?</h2>
  <div class="choice-grid">
    <div class="choice-card">
      <h3>Create Character</h3>
      <p class="muted">Walk through steps, then export to PDF or Discord.</p>
      <button class="btn next-btn" onclick="route('char-0')">Start Character Creator</button>
    </div>
    <div class="choice-card">
      <h3>Design Animal Companion</h3>
      <p class="muted">Pick size and details. Export too.</p>
      <button class="btn link-btn" onclick="route('ally')">Open Companion Designer</button>
    </div>
    <div class="choice-card">
      <h3>Design Hireling</h3>
      <p class="muted">Use the hireling statline, choose skills, export.</p>
      <button class="btn link-btn" onclick="route('hire')">Open Hireling Designer</button>
    </div>
    <div class="choice-card">
      <h3>Look in the General Store</h3>
      <p class="muted">Browse items and descriptions.</p>
      <button class="btn link-btn" onclick="route('store')">Open General Store</button>
    </div>
  </div>

  <!-- FRONT-PAGE JSON LOAD -->
  <div class="panel" style="margin-top:16px">
    <h3>Load a Saved File</h3>
    <p class="muted">Load any Character, Companion, or Hireling JSON. You’ll jump to the right screen automatically.</p>
    <input id="jsonFileHome" type="file" accept="application/json">
  </div>
</div>

<!-- ========== STEP 0: NEW vs SEASONED ========== -->
<div class="step hidden" id="char-0">
  <h2>Step 0: New or Seasoned Adventurer?</h2>
  <div class="choice-grid">
    <div class="choice-card">
      <h3>New Adventurer</h3>
      <p class="muted">Standard random Gold & Hero Point roll.</p>
      <button class="btn next-btn" onclick="chooseNew()">Choose New</button>
    </div>
    <div class="choice-card">
      <h3>Seasoned Adventurer</h3>
      <p class="muted">Override Gold, +1 Hero Point, optional Magical Artefact.</p>
      <button class="btn link-btn" onclick="showSeasoned()">Choose Seasoned</button>
    </div>
  </div>

  <div id="seasonedBox" class="panel hidden">
    <h3>Seasoned Options</h3>
    <div class="grid2">
      <label>Override Gold (GP)
        <input id="seasonGold" type="number" min="0" step="1" placeholder="leave blank for random">
      </label>
      <label>Add +1 Hero Point?
        <select id="seasonHeroPlus1Sel">
          <option value="No" selected>No</option>
          <option value="Yes">Yes (+1)</option>
        </select>
      </label>
    </div>

    <label>Include a Magical Artefact?
      <select id="seasonArtefactSel" onchange="toggleArtefactSel()">
        <option value="No" selected>No</option>
        <option value="Yes">Yes (uses 1 slot)</option>
      </select>
    </label>

    <div id="artefactBox" class="panel hidden" style="margin-top:10px">
      <h4>Artefact Designer</h4>
      <div class="grid2">
        <label>Name <input id="artName" type="text" placeholder="e.g., Sunshard"></label>
        <label>Type
          <select id="artType">
            <option value="Standard">Standard (MIND check to activate; value 30 GP)</option>
            <option value="Fabled">Fabled (no MIND check; value 150 GP)</option>
          </select>
        </label>
        <label>Range
          <select id="artRange">
            <option>Touch (Melee/Self)</option>
            <option>Ranged (Near–Far)</option>
          </select>
        </label>
        <label>Charges
          <input id="artCharges" type="text" placeholder="e.g., 1D, 3, or 6 max">
        </label>
      </div>
      <label class="grow">Effect / Notes
        <textarea id="artEffect" placeholder="Describe form & effect (often tied to the Hero’s Goal)."></textarea>
      </label>
    </div>

    <div>
      <button class="btn next-btn" onclick="applySeasoned()">Apply & Continue</button>
      <button class="btn reset-btn" onclick="revertToNew()">Revert to New Adventurer</button>
      <button class="btn reset-btn" onclick="route('home')">Cancel</button>
    </div>
  </div>

  <div style="margin-top:8px">
    <button class="btn reset-btn" onclick="route('home')">Back</button>
  </div>
</div>

<!-- ========== CHARACTER CREATOR (steps) ========== -->
<div class="step hidden" id="char-1">
  <h2>Step 1: Community & Role</h2>
  <div class="grid2">
    <label>Community
      <select id="community" onchange="onCommunityChange()">
        <option value="">-- Select --</option>
        <option>Dwarf</option><option>Elf</option><option>Goblin</option>
        <option>Halfling</option><option>Human</option><option>Orc</option>
        <option value="__custom__">Custom Community…</option>
      </select>
    </label>
    <label>Role
      <select id="role" onchange="onRoleChange()">
        <option value="">-- Select --</option>
        <option>Archer</option><option>Barbarian</option><option>Cleric</option>
        <option>Rogue</option><option>Warrior</option><option>Wizard</option>
        <option value="__custom__">Custom Role…</option>
      </select>
    </label>
  </div>

  <div id="customCommunityBox" class="panel hidden">
    <h3>Custom Community</h3>
    <div class="grid2">
      <label class="grow">Community Name
        <input id="customCommunityName" type="text" placeholder="e.g., Aetherborn" oninput="updateChar()">
      </label>
      <div class="grow"></div>
      <label class="grow">Community Skill 1
        <input id="customCommunitySkill1" type="text" placeholder="e.g., Sky-Navigation" oninput="updateChar()">
      </label>
      <label class="grow">Community Skill 2
        <input id="customCommunitySkill2" type="text" placeholder="e.g., Storm Sense" oninput="updateChar()">
      </label>
    </div>
    <p class="muted">Languages include <strong>Common</strong> + <strong>&lt;Community Name&gt; tongue</strong>.</p>
  </div>

  <div id="customRoleBox" class="panel hidden">
    <h3>Custom Role</h3>
    <div class="grid2">
      <label class="grow">Role Name
        <input id="customRoleName" type="text" placeholder="e.g., Battledancer" oninput="updateChar()">
      </label>
      <div class="grow"></div>
      <label class="grow">Role Skill 1
        <input id="customRoleSkill1" type="text" placeholder="e.g., Flowing Strike" oninput="updateChar()">
      </label>
      <label class="grow">Role Skill 2
        <input id="customRoleSkill2" type="text" placeholder="e.g., Whirl Evasion" oninput="updateChar()">
      </label>
    </div>
  </div>

  <div>
    <button class="btn next-btn" onclick="route('char-2')">Next</button>
    <button class="btn reset-btn" onclick="route('char-0')">Back</button>
  </div>
</div>

<div class="step hidden" id="char-2">
  <h2>Step 2: Proficiency</h2>
  <p class="muted">(High favors MIGHT; Low favors MIND.)</p>
  <input type="number" id="prof" min="2" max="5" onchange="updateChar()">
  <div>
    <button class="btn next-btn" onclick="route('char-3')">Next</button>
    <button class="btn reset-btn" onclick="route('char-1')">Back</button>
  </div>
</div>

<div class="step hidden" id="char-3">
  <h2>Step 3: Name</h2>
  <input type="text" id="name" placeholder="Hero Name" oninput="updateChar()">
  <div>
    <button class="btn next-btn" onclick="route('char-4')">Next</button>
    <button class="btn reset-btn" onclick="route('char-2')">Back</button>
  </div>
</div>

<div class="step hidden" id="char-4">
  <h2>Step 4: Homeland</h2>
  <input type="text" id="home" placeholder="Homeland" oninput="updateChar()">
  <div>
    <button class="btn next-btn" onclick="route('char-5')">Next</button>
    <button class="btn reset-btn" onclick="route('char-3')">Back</button>
  </div>
</div>

<div class="step hidden" id="char-5">
  <h2>Step 5: Goal</h2>
  <input type="text" id="goal" placeholder="Hero Goal" oninput="updateChar()">
  <div>
    <button class="btn next-btn" onclick="route('char-6')">Next</button>
    <button class="btn reset-btn" onclick="route('char-4')">Back</button>
  </div>
</div>

<div class="step hidden" id="char-6">
  <h2>Step 6: Appearance & Image</h2>
  <div class="row">
    <img id="avatar" class="avatar" alt="Character image preview">
    <div class="grow">
      <textarea id="app" placeholder="Describe your hero..." oninput="updateChar()"></textarea>
      <label class="muted">Upload image (JPG/PNG/GIF)
        <input type="file" id="imgInput" accept="image/*" onchange="loadAvatar(event)">
      </label>
    </div>
  </div>
  <div>
    <button class="btn next-btn" onclick="route('char-7')">Next</button>
    <button class="btn reset-btn" onclick="route('char-5')">Back</button>
  </div>
</div>

<div class="step hidden" id="char-7">
  <h2>Step 7: Languages</h2>
  <p>All heroes know <strong>Common</strong>. Non-humans also know their Community tongue. Humans may choose <strong>two extra</strong> languages:</p>
  <div id="languageChoice" class="hidden">
    <select id="extraLang" multiple size="6" onchange="updateChar()">
      <option value="Dwarvish">Dwarvish</option>
      <option value="Elvish">Elvish</option>
      <option value="Goblin Tongue">Goblin Tongue</option>
      <option value="Halfling Speech">Halfling Speech</option>
      <option value="Orcish">Orcish</option>
      <option value="Other">Other</option>
    </select>
    <p class="muted"><em>Hold CTRL (Windows) or CMD (Mac) to select two.</em></p>
  </div>
  <div>
    <button class="btn next-btn" onclick="route('char-8')">Next</button>
    <button class="btn reset-btn" onclick="route('char-6')">Back</button>
  </div>
</div>

<div class="step hidden" id="char-8">
  <h2>Step 8: Equipment & Output</h2>
  <div class="tools-grid">
    <!-- SHOP -->
    <div class="panel">
      <h3>Buy Equipment</h3>
      <p><strong>Pouch:</strong> <span id="gold">-</span> GP | <span id="silver">-</span> SP</p>

      <div class="row" style="align-items:center">
        <label class="grow">Other (Pouch for gems, personal and mundane items; Equipment for slots)
          <input id="pouchOtherInput" type="text" placeholder="e.g., small ruby; journal; pipe">
        </label>
        <label><input type="radio" name="otherDest" value="pouch" checked> To Pouch</label>
        <label><input type="radio" name="otherDest" value="equipment"> To Equipment</label>
        <button class="btn link-btn" onclick="addOther()">Add</button>
        <button class="btn link-btn" onclick="undoLastPurchase()">Undo last purchase</button>
      </div>

      <!-- Weapon purchase UI -->
      <div class="panel" style="margin-top:8px">
        <h4>Buy Weapon</h4>
        <div class="row" style="align-items:center">
          <label>Type
            <select id="wpnType" onchange="updateWeaponHint()">
              <option value="1H">1H</option>
              <option value="2H">2H</option>
            </select>
          </label>
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="checkbox" id="wpnSilver" onchange="updateWeaponHint()"> Silvered (x2 cost)
          </label>
          <button class="btn buy-btn" onclick="buyWeapon()">Buy Weapon</button>
          <span class="muted" id="wpnCostHint">Cost: 3 GP</span>
        </div>
        <p class="muted" style="margin:0">Silvered weapons cost twice the normal price and grant +1 DMG vs Undead/Evil (break on 1/6).</p>
      </div>

      <h4>1 GP Items</h4><div id="shop1"></div>
      <h4>3 GP Items</h4><div id="shop3"></div>
      <h4>6 GP Items</h4><div id="shop6"></div>
    </div>

    <!-- EXPORT / DISCORD / JSON -->
    <div class="panel">
      <h3>Discord & Files</h3>
      <label>Divider
        <select id="dsDivider">
          <option value="dash" selected>──────── (light)</option>
          <option value="double">════════ (double)</option>
          <option value="heavy">━━━━━━━━ (heavy)</option>
          <option value="equals">================================ (equals)</option>
        </select>
      </label><br>
      <label>Heading Font
        <select id="dsFont">
          <option value="normal" selected>Normal</option>
          <option value="bold">Bold (Unicode)</option>
          <option value="smallcaps">Small Caps (Unicode)</option>
        </select>
      </label><br>
      <label>Heading Color
        <select id="dsColor">
          <option value="none" selected>None</option>
          <option value="green">Green</option>
          <option value="blue">Blue</option>
          <option value="red">Red</option>
          <option value="yellow">Yellow</option>
          <option value="magenta">Magenta</option>
          <option value="cyan">Cyan</option>
          <option value="white">White</option>
          <option value="gray">Gray</option>
        </select>
      </label><br>
      <label>Headline Frame
        <select id="dsFrame">
          <option value="none" selected>None</option>
          <option value="brackets">[ Title ]</option>
          <option value="rounded">╭ Title ╮</option>
          <option value="heavy">┏ Title ┓</option>
          <option value="double">╔ Title ╗</option>
        </select>
      </label>
      <hr class="hr">
      <button class="btn print-btn" onclick="printSheet('charSheet')">Download PDF</button>
      <button class="btn next-btn" onclick="copyDiscordChar()">Copy Character to Discord</button>
      <div class="row">
        <button class="btn link-btn" onclick="downloadJSONWithName('char')">Save JSON</button>
        <input id="jsonFile" type="file" accept="application/json" class="hidden" onchange="uploadJSON(event)">
        <button class="btn link-btn" onclick="document.getElementById('jsonFile').click()">Load JSON</button>
      </div>
      <button class="btn reset-btn" onclick="resetAll()">Reset</button>
    </div>
  </div>
</div>

<!-- CHARACTER SHEET -->
<div class="sheet hidden" id="charSheet">
  <h2>Character Sheet</h2>

  <div class="section">
    <h4>Identity</h4><div class="hr"></div>
    <div class="row" style="align-items:center">
      <img id="avatarSheet" class="avatar" alt="Character image" style="display:none">
      <div class="grow">
        <p><strong>Name:</strong> <span id="outName">-</span></p>
        <p><strong>Homeland:</strong> <span id="outHome">-</span></p>
        <p><strong>Community:</strong> <span id="outCommunity">-</span></p>
        <p><strong>Role:</strong> <span id="outRole">-</span></p>
        <p><strong>Goal:</strong> <span id="outGoal">-</span></p>
        <p><strong>Appearance:</strong> <span id="outApp">-</span></p>
      </div>
    </div>
  </div>

  <div class="section">
    <h4>Stats</h4><div class="hr"></div>
    <p><strong>Proficiency:</strong> <span id="outProf">-</span></p>
    <p><strong>Stamina:</strong> <span id="outStamina">-</span></p>
    <p id="outArmorNote" class="muted" style="margin-top:-6px">Armor: None</p>
    <p><strong>Hero Points:</strong> <span id="outHeroTotal">-</span></p>
    <p id="outHeroNote" class="muted" style="margin-top:-6px">—</p>
    <p><strong>Languages:</strong> <span id="outLang">Common</span></p>
  </div>

  <div class="section">
    <h4>Skills</h4><div class="hr"></div>
    <ul id="outSkills"></ul>
  </div>

  <div class="section">
    <h4>Spells</h4><div class="hr"></div>
    <div id="spellBlock"><p>—</p></div>
  </div>

  <div class="section">
    <h4>Pouch</h4><div class="hr"></div>
    <p><strong>Gold:</strong> <span id="outGold">-</span> GP</p>
    <p><strong>Silver:</strong> <span id="outSilver">-</span> SP</p>
    <p><strong>Other:</strong> <span id="outOther">—</span></p>
  </div>

  <div class="section">
    <h4>Equipment <span id="equipWarn" class="warn"></span></h4><div class="hr"></div>
    <p id="equipCarryLine" class="muted" style="margin-top:-6px">Carry Capacity: -</p>
    <ul id="outGear"></ul>
  </div>

  <div class="section">
    <h4>Notes</h4><div class="hr"></div>
    <textarea id="charNotes" placeholder="Campaign, bonds, reminders… (included in Discord export)"></textarea>
  </div>
</div>

<!-- ========== COMPANION DESIGNER & SHEET ========== -->
<div class="step hidden" id="ally">
  <h2>Animal Companion Designer</h2>
  <div class="grid2">
    <label>Name <input id="allyName" type="text" oninput="updateAlly()"></label>
    <label>Type <input id="allyRole" type="text" placeholder="e.g., rat, dog, horse" oninput="updateAlly()"></label>
    <label>Size
      <select id="allySize" onchange="updateAlly()">
        <option value="Small">Small (3 GP, 1#)</option>
        <option value="Medium">Medium (6 GP, 6#)</option>
        <option value="Large">Large (12 GP, 4P)</option>
      </select>
    </label>
    <label>Stamina <input id="allyStamina" type="number" min="1" value="1" oninput="updateAlly()"></label>
    <label>Carry <input id="allyCarry" type="text" value="1#" oninput="updateAlly()"></label>
    <label>Pull <input id="allyPull" type="text" value="2#" oninput="updateAlly()"></label>
    <label class="grow">Skills (comma separated)
      <input id="allySkills" type="text" placeholder="1 = 1 Success; +1D if Skilled" oninput="updateAlly()">
    </label>
    <label class="grow">Temperament
      <input id="allyTemper" type="text" placeholder="e.g., loyal, skittish, aggressive" oninput="updateAlly()">
    </label>
    <label class="grow">Gear (comma separated)
      <input id="allyGear" type="text" placeholder="e.g., Saddle, Saddlebags" oninput="updateAlly()">
    </label>
  </div>
  <label class="grow">Notes
    <textarea id="allyNotes" placeholder="Any special abilities or GM notes." oninput="updateAlly()"></textarea>
  </label>
  <div>
    <button class="btn print-btn" onclick="printSheet('allySheet')">Download PDF</button>
    <button class="btn next-btn" onclick="copyDiscordAlly()">Copy for Discord</button>
    <button class="btn link-btn" onclick="downloadJSONWithName('ally')">Save JSON</button>
    <button class="btn reset-btn" onclick="resetAlly()">Reset Companion</button>
    <button class="btn link-btn" onclick="route('home')">Back to Home</button>
  </div>
</div>

<div class="sheet hidden" id="allySheet">
  <h2 id="allyHeader">Animal Companion</h2>
  <div class="section"><h4>Identity</h4><div class="hr"></div>
    <p><strong>Name:</strong> <span id="allyOutName">-</span></p>
    <p><strong>Type:</strong> <span id="allyOutRole">-</span></p>
    <p><strong>Size:</strong> <span id="allyOutSize">Small (3 GP, 1#)</span></p>
  </div>
  <div class="section"><h4>Stats</h4><div class="hr"></div>
    <p><strong>Stamina:</strong> <span id="allyOutStamina">1</span></p>
    <p><strong>Carry:</strong> <span id="allyOutCarry">1#</span></p>
    <p><strong>Pull:</strong> <span id="allyOutPull">2#</span></p>
  </div>
  <div class="section"><h4>Skills</h4><div class="hr"></div>
    <ul id="allyOutSkills"><li>—</li></ul>
  </div>
  <div class="section"><h4>Temperament</h4><div class="hr"></div>
    <p id="allyOutTemper">—</p>
  </div>
  <div class="section"><h4>Gear</h4><div class="hr"></div>
    <ul id="allyOutGear"><li>—</li></ul>
  </div>
  <div class="section"><h4>Notes</h4><div class="hr"></div>
    <p id="allyOutNotes">—</p>
  </div>
</div>

<!-- ========== HIRELING DESIGNER & SHEET ========== -->
<div class="step hidden" id="hire">
  <h2>Hireling Designer</h2>

  <div class="grid2">
    <label>Name <input id="hireName" type="text" oninput="updateHire()"></label>
    <label>Role / Job <input id="hireRole" type="text" placeholder="e.g., porter, guard" oninput="updateHire()"></label>

    <!-- Community Skill -->
    <label>Community Skill
      <select id="hireCmmSelect" onchange="onHireCmmChange()"></select>
    </label>
    <label class="hidden" id="hireCmmCustomLabel">Custom Community Skill
      <input id="hireCmmSkill" type="text" placeholder="type a skill" oninput="updateHire()">
    </label>

    <!-- Role Skill -->
    <label>Role Skill
      <select id="hireRoleSelect" onchange="onHireRoleChange()"></select>
    </label>
    <label class="hidden" id="hireRoleCustomLabel">Custom Role Skill
      <input id="hireRoleSkill" type="text" placeholder="type a skill" oninput="updateHire()">
    </label>

    <label>Stamina <input id="hireStamina" type="number" min="1" value="2" oninput="updateHire()"></label>

    <label>Can Cast 1 Spell?
      <select id="hireSpellYN" onchange="updateHire();toggleHireSpell()">
        <option value="No">No</option><option value="Yes">Yes</option>
      </select>
    </label>

    <label class="hidden" id="hireSpellSelectLabel">Spell
      <select id="hireSpellSelect" onchange="onHireSpellChange()"></select>
    </label>
    <label class="hidden" id="hireSpellCustomLabel">Custom Spell
      <input id="hireSpellName" type="text" placeholder="type a spell name" oninput="updateHire()">
    </label>

    <label class="grow">Gear (comma separated) <input id="hireGear" type="text" placeholder="You must equip them!" oninput="updateHire()"></label>

    <!-- Hireling Notes -->
    <label class="grow">Notes
      <textarea id="hireNotes" placeholder="Background, quirks, loyalties…" oninput="updateHire()"></textarea>
    </label>
  </div>

  <div class="panel">
    <h3>Hireling Statline (Rules)</h3>
    <ul>
      <li>Cost: Paid per adventure (GM sets fee).</li>
      <li>Equipment: Hero must provide weapons, armor, gear.</li>
      <li>Carry Capacity: 6#.</li>
      <li>Pull Capacity: 6# per 1H (–1D penalty).</li>
      <li>Skills: Starts with <em>1 Community Skill</em> and <em>1 Role Skill</em> (chosen by the Hero).</li>
      <li>Stamina: 2 (editable above).</li>
      <li>Magic: May know max. 1 spell (if applicable).</li>
      <li>Actions/Reactions: Player rolls 1D for them (+1D if Skilled; 1 = 1 Success).</li>
      <li>Control: GM roleplays the hireling.</li>
    </ul>
  </div>

  <div>
    <button class="btn print-btn" onclick="printSheet('hireSheet')">Download PDF</button>
    <button class="btn next-btn" onclick="copyDiscordHire()">Copy for Discord</button>
    <button class="btn link-btn" onclick="downloadJSONWithName('hire')">Save JSON</button>
    <button class="btn reset-btn" onclick="resetHire()">Reset Hireling</button>
    <button class="btn link-btn" onclick="route('home')">Back to Home</button>
  </div>
</div>

<div class="sheet hidden" id="hireSheet">
  <h2>Hireling Sheet</h2>
  <div class="section"><h4>Identity</h4><div class="hr"></div>
    <p><strong>Name:</strong> <span id="hireOutName">-</span></p>
    <p><strong>Role / Job:</strong> <span id="hireOutRole">-</span></p>
  </div>
  <div class="section"><h4>Stats</h4><div class="hr"></div>
    <p><strong>Stamina:</strong> <span id="hireOutStamina">2</span></p>
    <p><strong>Carry:</strong> 6#</p>
    <p><strong>Pull:</strong> 6# per 1H (–1D)</p>
  </div>
  <div class="section"><h4>Skills</h4><div class="hr"></div>
    <ul id="hireOutSkills"><li>Community Skill: —</li><li>Role Skill: —</li></ul>
    <p class="muted" style="margin-top:6px">Player rolls 1D for them (+1D if Skilled; 1 = 1 Success).</p>
  </div>
  <div class="section"><h4>Magic</h4><div class="hr"></div>
    <p><strong>Can cast 1 spell?</strong> <span id="hireOutSpellYN">No</span></p>
    <p><strong>Spell:</strong> <span id="hireOutSpellName">—</span></p>
  </div>
  <div class="section"><h4>Gear</h4><div class="hr"></div>
    <ul id="hireOutGear"><li>—</li></ul>
  </div>
  <div class="section"><h4>Notes</h4><div class="hr"></div>
    <p id="hireOutNotes">—</p>
  </div>
</div>

<!-- ========== GENERAL STORE (read-only) ========== -->
<div class="step hidden" id="store">
  <h2>General Store</h2>
  <p class="muted">Browse items. Use the Character Creator to buy & add gear.</p>
  <h3>1 GP Items</h3><ul id="store1"></ul>
  <h3>3 GP Items</h3><ul id="store3"></ul>
  <h3>6 GP Items</h3><ul id="store6"></ul>
  <p class="muted" id="storeFoot"></p>
  <button class="btn link-btn" onclick="route('home')">Back to Home</button>
</div>

<script>
/* ---------- Shortcuts ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

/* ---------- Global Route Tracker ---------- */
let currentRoute = 'home';

/* ---------- Routing ---------- */
function route(id){
  currentRoute = id;
  const screens=['home','char-0','char-1','char-2','char-3','char-4','char-5','char-6','char-7','char-8','ally','hire','store'];
  screens.forEach(k=>{ const el=document.getElementById(k); if(el) el.classList.add('hidden'); });
  ['charSheet','allySheet','hireSheet'].forEach(sid=>{ const el=document.getElementById(sid); if(el) el.classList.add('hidden'); });
  const el=document.getElementById(id); if(el) el.classList.remove('hidden');
  if(id.startsWith('char-')) $('#charSheet').classList.remove('hidden');
  else if(id==='ally') $('#allySheet').classList.remove('hidden');
  else if(id==='hire') $('#hireSheet').classList.remove('hidden');
  updateChar(); updateAlly(); updateHire();
}

/* ---------- Print ---------- */
function printSheet(sheetId){
  $$('.sheet').forEach(s=>s.classList.remove('printing'));
  const target=document.getElementById(sheetId); if(!target) return;
  const wasHidden=target.classList.contains('hidden');
  if(wasHidden) target.classList.remove('hidden');
  target.classList.add('printing'); window.print(); target.classList.remove('printing');
  if(wasHidden) target.classList.add('hidden');
}

/* ---------- Clipboard ---------- */
async function copyText(text){
  try{
    const ta=document.createElement("textarea");
    ta.value=text; ta.setAttribute("readonly",""); ta.style.position="fixed"; ta.style.top="-1000px";
    document.body.appendChild(ta); ta.focus(); ta.select(); ta.setSelectionRange(0, ta.value.length);
    const ok=document.execCommand("copy"); document.body.removeChild(ta);
    if(navigator.clipboard && window.isSecureContext){ try{ await navigator.clipboard.writeText(text); }catch(e){} }
    alert(ok ? "Copied to clipboard!" : "Tried to copy — if it didn’t work, press Ctrl/Cmd+C.");
    return ok;
  }catch(e){ console.error(e); alert("Copy failed — press Ctrl/Cmd+C."); return false; }
}

/* ---------- Discord helpers ---------- */
function toBold(s){ return s
  .replace(/[A-Z]/g,c=>String.fromCodePoint(c.charCodeAt(0)-0x41+0x1D400))
  .replace(/[a-z]/g,c=>String.fromCodePoint(c.charCodeAt(0)-0x61+0x1D41A))
  .replace(/[0-9]/g,d=>String.fromCodePoint(d.charCodeAt(0)-0x30+0x1D7CE)); }
const smallCapsMap={a:"ᴀ",b:"ʙ",c:"ᴄ",d:"ᴅ",e:"ᴇ",f:"ꜰ",g:"ɢ",h:"ʜ",i:"ɪ",j:"ᴊ",k:"ᴋ",l:"ʟ",m:"ᴍ",n:"ɴ",o:"ᴏ",p:"ᴘ",q:"ǫ",r:"ʀ",s:"s",t:"ᴛ",u:"ᴜ",v:"ᴠ",w:"ᴡ",x:"x",y:"ʏ",z:"ᴢ"};
function toSmallCaps(s){ return s.split("").map(ch=>smallCapsMap[ch.toLowerCase()]||ch).join(""); }
function fontify(s,mode){ if(mode==="bold") return toBold(s); if(mode==="smallcaps") return toSmallCaps(s); return s; }
const ANSI={reset:"\u001b[0m", fg:{none:"",green:"\u001b[32m",blue:"\u001b[34m",red:"\u001b[31m",yellow:"\u001b[33m",magenta:"\u001b[35m",cyan:"\u001b[36m",white:"\u001b[37m",gray:"\u001b[90m"}};
function colorize(s,c){ return c==="none" ? s : ANSI.fg[c] + s + ANSI.reset; }
function makeDivider(kind){ const w=40; if(kind==="double")return"═".repeat(w); if(kind==="heavy")return"━".repeat(w); if(kind==="equals")return"=".repeat(w); return"─".repeat(w); }
function frameTitle(txt,frame){ if(frame==="none")return txt; if(frame==="brackets")return`[ ${txt} ]`; if(frame==="rounded")return`╭ ${txt} ╮`; if(frame==="heavy")return`┏ ${txt} ┓`; if(frame==="double")return`╔ ${txt} ╗`; return txt; }

/* ---------- Character state ---------- */
function rollDice(s){ return Math.floor(Math.random()*s)+1; }
let gp, sp, gear, purchaseHistory=[];
let avatarDataURL="", avatarFilename="", pouchOthers=[];
let heroRoll=0, seasonedBonus=false, seasonedMode=false;
let artefactOn=false, artefact={name:"",type:"Standard",range:"Touch (Melee/Self)",charges:"",effect:""};
let lastOverCap=false;

/* Skills DB (with tags) */
const skillsDB = {
  Dwarf:[["Detect","MIND"],["Teamwork","Help"]],
  Elf:[["Acrobatics","MIGHT"],["Pathfinder","MIND"]],
  Goblin:[["Darksee","Automatic"],["Underground","MIND"]],
  Halfling:[["Hide","MIND"],["Willpower","MIND"]],
  Human:[["Parley","MIND"],["Languages (+2)","MIND"]],
  Orc:[["Athletics","MIGHT"],["Resilience","MIGHT"]],
  Archer:[["Launched Weapons","MIGHT"],["1H Throw","MIGHT"]],
  Barbarian:[["2H Weapons","MIGHT"],["2H Throw","MIGHT"]],
  Cleric:[["Religion","MIND"]],
  Rogue:[["Sneak","MIND"],["Tinker","MIND"]],
  Warrior:[["1H Weapons","MIGHT"],["Unarmed","MIGHT"]],
  Wizard:[["Arcana","MIND"]]
};

/* ===== Spells with full descriptions ===== */
const spellsArcane = {
  "Darksee": { stat:"MIND", desc:"Self, see in greyscale for +1D R, Far" },
  "Levitate": { stat:"MIND", desc:"Self, float for +1R; 1 vertical Near Move per Round" },
  "Missile": { stat:"MIND", desc:"Far, bolt of energy, 1 DMG" },
  "Protection": { stat:"MIND", desc:"Self, -1 DMG from 1 Attack per Round (Free Action; no Spell Drain)" },
  "Speak": { stat:"MIND", desc:"Self, communicate with any sentient being for +1D R" },
  "Teleport": { stat:"MIND", desc:"Self, to 1 previously visited spot, up to Far" }
};
const spellsHoly = {
  "Bless": { stat:"MIND", desc:"Touch, +1D to 1 Proficiency Check next Round" },
  "Divine": { stat:"MIND", desc:"Touch, reveal beyond or within 1 structure, Near" },
  "Heal": { stat:"MIND", desc:"Touch, restore 1 Stamina point" },
  "Light": { stat:"MIND", desc:"Touch, as if day, for +1D R, Near" },
  "Smite": { stat:"MIND", desc:"Touch, Holy Weapon +1 DMG (Free Action; no Spell Drain)" },
  "Ward": { stat:"MIND", desc:"Far, prevent 1 Target from 1 Move into your Melee within +1D R" }
};

/* Store/Shop */
const shop={
  gp1:["Acid","Caltrops","Candles (6)","Fire Pot","Grappling Hook","Oil (6)","Pitons (6)","Provisions (6)","Rope","Small Mirror","Tinderbox","Torches (6)"],
  gp3:["Animal Companion (Small)","Armor","Heavy Armor","Arrows (6)","Cart","Lantern","Net","Bolas","Shield","Heavy Shield","Spyglass","Throwing Blades (6)","Tinker Tools","Specialist Tools"],
  gp6:["Healing Kit/Herbs (6)","Hireling","Holy Water","Magic Recharge +1","Poison","Potion","Scroll","Spellcasting Item"]
};

const itemNotes={
  "Armor":"+1 Stamina; ½ Move to Climb & Swim",
  "Heavy Armor":"+2 Stamina; ½ Move to Climb & Swim; -1D Dodge",
  "Shield":"Block: +1D; may negate all DMG once/round",
  "Heavy Shield":"Block: auto-negate 1 attack/round if successful",
  "Cart":"-1D when pulling",
  "Animal Companion (Small)":"Stamina 1; carry 1#; pull 2#",
  "Animal Companion (Medium)":"Stamina 2; carry 3#; pull 6#",
  "Animal Companion (Large)":"Stamina 3; carry 1P; pull 2P",
  "Hireling":"Stamina 2; carries 6#; 1 Community + 1 Role skill"
};
function formatItem(n){ return itemNotes[n] ? `${n} (${itemNotes[n]})` : n; }

const storeCatalog = {
  gp1:[
    ["Acid","1 DMG or dissolves 1# Item (e.g., armor or lock)"],
    ["Caltrops","Traverse = halves Move or 1 DMG"],
    ["Candles (6)","Near (Lantern), 1h each"],
    ["Fire Pot","1 Fire DMG on impact"],
    ["Grappling Hook","—"],
    ["Oil (6)","1h each"],
    ["Pitons (6)","Needs hammer"],
    ["Provisions (6)","1/day (2 for Large)"],
    ["Rope","Far length"],
    ["Small Mirror","—"],
    ["Tinderbox","—"],
    ["Torches (6)","Near light, 1h"]
  ],
  gp3:[
    ["Animal Companion*","Small/Medium/Large"],
    ["Armor / Heavy","+1 or +2 Stamina; penalties listed on sheet"],
    ["Arrows (6)","Retrieve 3/6"],
    ["Cart","Per 6# load; -1D pull"],
    ["Lantern","Near open / Far point beam"],
    ["Net / Bolas","2H throw snare / 1H"],
    ["Shield / Heavy","Block; heavy can fully negate once/round if success"],
    ["Spyglass","—"],
    ["Throwing Blades (6)","Retrieve 3/6"],
    ["Tinker / Specialist Tools","Locks / chosen profession"],
    ["Weapon (1H/2H)","3 GP; Silvered = x2 cost, +1 DMG vs Undead/Evil (break 1/6) — use Weapon panel"]
  ],
  gp6:[
    ["Healing Kit/Herbs (6)","Std MIND = -1 DMG"],
    ["Hireling*","See rules"],
    ["Holy Water","2 DMG vs Evil"],
    ["Magic Recharge +1","Recharge artefacts"],
    ["Poison","Check might/size; fail=1 DMG & -1D +1D R"],
    ["Potion","2 successes, 1-use"],
    ["Scroll","Far; Std MIND=2 succ; no drain on success/fail"],
    ["Spellcasting Item/Weapon","Unique to caster; -1D without"]
  ],
  foot:"* Combined companions/hirelings ≤ (6 − Proficiency)."
};

function renderStore(){
  const makeLis = arr => arr.map(([n,d])=>`<li><strong>${n}</strong>${d && d!=='—' ? ` — ${d}` : ''}</li>`).join("");
  $("#store1").innerHTML = makeLis(storeCatalog.gp1);
  $("#store3").innerHTML = makeLis(storeCatalog.gp3);
  $("#store6").innerHTML = makeLis(storeCatalog.gp6);
  $("#storeFoot").innerText = storeCatalog.foot;
}

function initShop(){
  const make = (sel,list,cost) => { $(sel).innerHTML = list.map(it=>`<button class="buy-btn" onclick="buyItem('${it}',${cost})">${it} (${cost} GP)</button>`).join(" "); };
  make("#shop1",shop.gp1,1); make("#shop3",shop.gp3,3); make("#shop6",shop.gp6,6);
}

function buyItem(name,cost){
  if(gp>=cost){ gp-=cost; gear.push(formatItem(name)); purchaseHistory.push({name:formatItem(name), cost}); updateChar(true); }
  else if(confirm(`Not enough GP (${gp} left). Buy ${name} anyway and go into debt?`)){
    gp-=cost; gear.push(formatItem(name)); purchaseHistory.push({name:formatItem(name), cost}); updateChar(true);
  }
}

function undoLastPurchase(){
  const last = purchaseHistory.pop();
  if(!last){ alert("Nothing to undo."); return; }
  const idx = gear.lastIndexOf(last.name);
  if(idx>-1) gear.splice(idx,1);
  gp += last.cost;
  updateChar();
}

/* Weapon purchase (3 GP base; silvered x2) */
function updateWeaponHint(){
  const base=3;
  const silver = $("#wpnSilver").checked;
  const cost = base * (silver?2:1);
  $("#wpnCostHint").innerText = `Cost: ${cost} GP`;
}
function buyWeapon(){
  const kind = $("#wpnType").value;
  const silver = $("#wpnSilver").checked;
  const base=3;
  const cost = base * (silver?2:1);
  const name = silver ? `Weapon (${kind}) [Silvered]` : `Weapon (${kind})`;
  if(gp>=cost){ gp-=cost; gear.push(name); purchaseHistory.push({name, cost}); updateChar(true); }
  else if(confirm(`Not enough GP (${gp} left). Buy ${name} for ${cost} GP anyway and go into debt?`)){
    gp-=cost; gear.push(name); purchaseHistory.push({name, cost}); updateChar(true);
  }
}

/* Other (pouch/equipment) */
function addOther(){
  const raw = ($("#pouchOtherInput").value||"").trim();
  if(!raw){ alert("Type something to add."); return; }
  const dest = (document.querySelector('input[name="otherDest"]:checked')||{}).value || "pouch";
  if(dest==="equipment") gear.push(raw); else pouchOthers.push(raw);
  $("#pouchOtherInput").value=""; updateChar(true);
}

/* Step 0 logic */
function chooseNew(){
  seasonedMode=false; seasonedBonus=false; artefactOn=false;
  artefact={name:"",type:"Standard",range:"Touch (Melee/Self)",charges:"",effect:""};
  route('char-1');
}
function showSeasoned(){
  seasonedMode=true; $("#seasonedBox").classList.remove("hidden");
}
function toggleArtefactSel(){
  artefactOn = ($("#seasonArtefactSel").value==="Yes");
  $("#artefactBox").classList.toggle("hidden", !artefactOn);
}
function applySeasoned(){
  seasonedMode=true;
  const goldStr=$("#seasonGold").value.trim();
  if(goldStr!==""){ const val=parseInt(goldStr,10); if(!isNaN(val) && val>=0) gp = val; }
  seasonedBonus = ($("#seasonHeroPlus1Sel").value==="Yes");
  artefactOn = ($("#seasonArtefactSel").value==="Yes");
  if(artefactOn){
    artefact.name = ($("#artName").value||"").trim() || "Unnamed Artefact";
    artefact.type = $("#artType").value || "Standard";
    artefact.range = $("#artRange").value || "Touch (Melee/Self)";
    artefact.charges = ($("#artCharges").value||"").trim() || "1D";
    artefact.effect = ($("#artEffect").value||"").trim() || "—";
  }else{
    artefact={name:"",type:"Standard",range:"Touch (Melee/Self)",charges:"",effect:""};
  }
  route('char-1');
}

/* Revert button */
function revertToNew(){
  seasonedMode=false; seasonedBonus=false; artefactOn=false;
  artefact={name:"",type:"Standard",range:"Touch (Melee/Self)",charges:"",effect:""};
  $("#seasonGold").value="";
  $("#seasonHeroPlus1Sel").value="No";
  $("#seasonArtefactSel").value="No";
  $("#artefactBox").classList.add("hidden");
  gp=12+rollDice(6); sp=rollDice(6); heroRoll=rollDice(6);
  updateChar(); route('char-1');
}

/* Avatar */
function loadAvatar(e){
  const f=e.target.files?.[0]; if(!f){ clearAvatar(); updateChar(); return; }
  avatarFilename = f.name || "portrait.png";
  const r=new FileReader();
  r.onload = ev => { avatarDataURL = ev.target.result; $("#avatar").src=avatarDataURL; updateChar(); };
  r.readAsDataURL(f);
}
function clearAvatar(){
  avatarDataURL=""; avatarFilename="";
  const imgPrev=$("#avatar"); if(imgPrev){ imgPrev.removeAttribute("src"); }
  const imgSheet=$("#avatarSheet"); if(imgSheet){ imgSheet.removeAttribute("src"); imgSheet.style.display="none"; }
  const fileIn=$("#imgInput"); if(fileIn){ fileIn.value=""; }
}

/* STEP 1 show/hide custom boxes */
function onCommunityChange(){ $("#customCommunityBox").classList.toggle("hidden", $("#community").value!=="__custom__"); updateChar(); }
function onRoleChange(){ $("#customRoleBox").classList.toggle("hidden", $("#role").value!=="__custom__"); updateChar(); }

/* Gear with artefact */
function currentGearList(){
  const list=[...gear];
  if(artefactOn){
    const a=`Artefact: ${artefact.name} (${artefact.type}; ${artefact.range}; Charges: ${artefact.charges}; Effect: ${artefact.effect})`;
    list.push(a);
  }
  return list;
}

/* Numbered gear (0# base not counting towards capacity) */
function numberedGearLines(){
  const base0 = `0#: Adventurer's Clothing; Backpack; Pouch`;
  const rest = currentGearList().filter(it => it!=="Clothing" && it!=="Backpack");
  return [base0, ...rest.map((it,i)=>`${i+1}#: ${it}`)];
}

/* Armor bonus */
function getEquippedArmor(){
  const g=currentGearList();
  const hasHeavy = g.some(x=>/^Heavy Armor\b/.test(x));
  const hasArmor = g.some(x=>/^Armor\b/.test(x));
  if(hasHeavy) return { type:"Heavy Armor", bonus:2, note:"Heavy Armor (+2 Stamina; ½ Move to Climb & Swim; -1D Dodge)" };
  if(hasArmor) return { type:"Armor", bonus:1, note:"Armor (+1 Stamina; ½ Move to Climb & Swim)" };
  return { type:"None", bonus:0, note:"Armor: None" };
}

/* Update Character Sheet */
function updateChar(triggeredByAdd=false){
  const name=$("#name")?.value||"-";
  const home=$("#home")?.value||"-";
  const goal=$("#goal")?.value||"-";
  const app=$("#app")?.value||"-";
  const commSel=$("#community")?.value||"-";
  const roleSel=$("#role")?.value||"-";
  const prof=parseInt($("#prof")?.value)||"-";

  const customCommName=($("#customCommunityName")?.value||"").trim();
  const customCommSkills=[($("#customCommunitySkill1")?.value||"").trim(),($("#customCommunitySkill2")?.value||"").trim()].filter(Boolean);
  const customRoleName=($("#customRoleName")?.value||"").trim();
  const customRoleSkills=[($("#customRoleSkill1")?.value||"").trim(),($("#customRoleSkill2")?.value||"").trim()].filter(Boolean);

  const commName = (commSel==="__custom__" ? (customCommName||"Custom Community") : commSel);
  const roleName = (roleSel==="__custom__" ? (customRoleName||"Custom Role") : roleSel);

  // Languages
  let langs=["Common"];
  const langBox=$("#languageChoice");
  if(commSel==="Human"){
    langBox?.classList.remove("hidden");
    let extras=[...($("#extraLang")?.selectedOptions||[])].map(o=>o.value);
    if(extras.length>2) extras=extras.slice(0,2);
    langs=langs.concat(extras);
  }else{
    langBox?.classList.add("hidden");
    if(commSel && commSel!=="-"){
      const tongue = (commSel==="__custom__") ? `${commName} tongue` : `${commSel} tongue`;
      langs.push(tongue);
    }
  }

  // Skills with tags
  const commSkills = (commSel==="__custom__") ? customCommSkills.map(s=>[s,""]) : (skillsDB[commSel]||[]);
  const roleSkills = (roleSel==="__custom__") ? customRoleSkills.map(s=>[s,""]) : (skillsDB[roleSel]||[]);
  const allSkills = [...commSkills, ...roleSkills];
  $("#outSkills").innerHTML = allSkills.length ? allSkills.map(([s,t])=>`<li>${s}${t?` (${t})`:""}</li>`).join("") : "<li>—</li>";

  // Spells preview (with descriptions)
  const sb=$("#spellBlock");
  if(roleName==="Wizard"){
    sb.innerHTML = "<ul>"+Object.entries(spellsArcane).map(([k,v])=>`<li><strong>${k}</strong>: ${v.desc} (${v.stat})</li>`).join("")+"</ul>";
  } else if(roleName==="Cleric"){
    sb.innerHTML = "<ul>"+Object.entries(spellsHoly).map(([k,v])=>`<li><strong>${k}</strong>: ${v.desc} (${v.stat})</li>`).join("")+"</ul>";
  } else { sb.innerHTML = "<p>—</p>"; }

  // Armor, Stamina, Carry cap
  const equip = getEquippedArmor();
  const staminaTotal = (prof!="-") ? (prof + equip.bonus) : "-";
  const carryCap = (prof!="-") ? (prof + 6) : "-";

  // Identity & Stats
  $("#outName").innerText=name; $("#outHome").innerText=home; $("#outGoal").innerText=goal; $("#outApp").innerText=app;
  $("#outCommunity").innerText=commName; $("#outRole").innerText=roleName;
  $("#outProf").innerText=prof; $("#outStamina").innerText=staminaTotal;
  $("#outArmorNote").innerText = (equip.type==="None") ? "Armor: None" : `Armor: ${equip.note}`;
  $("#outLang").innerText=langs.join(", ");

  // Hero Points
  const hpTotal=heroRoll?(heroRoll+(seasonedBonus?1:0)):"-";
  const hpNote=heroRoll?(seasonedBonus?`(rolled 1d6 got ${heroRoll}; +1 Seasoned Adventurer → total ${hpTotal})`:`(rolled 1d6 got ${heroRoll} → total ${hpTotal})`):"—";
  $("#outHeroTotal").innerText=hpTotal; $("#outHeroNote").innerText=hpNote;

  // Equipment list + capacity & warning
  const eqLines = numberedGearLines();
  const usedSlots = Math.max(eqLines.length-1,0);
  const overCap = (prof!="-") && (usedSlots > carryCap);
  $("#equipWarn").innerText = overCap ? "– Exceeding capacity: -1D penalty" : "";
  $("#equipCarryLine").innerText = `Carry Capacity: ${carryCap}`;
  $("#outGear").innerHTML = eqLines.map(l=>`<li>${l}</li>`).join("");

  if(triggeredByAdd){
    if(overCap && !lastOverCap){ alert("-1D Penalty for exceeding your Carry Capacity"); }
    lastOverCap = overCap;
  }else{
    lastOverCap = overCap;
  }

  // Pouch values
  $("#gold").innerText=gp; $("#silver").innerText=sp;
  $("#outGold").innerText=gp; $("#outSilver").innerText=sp;
  $("#outOther").innerText=(pouchOthers.length ? pouchOthers.join("; ") : "—");

  // Image on sheet
  const aS=$("#avatarSheet");
  if(aS){ if(avatarDataURL){ aS.src=avatarDataURL; aS.style.display="block"; } else { aS.removeAttribute("src"); aS.style.display="none"; } }
}

/* Discord: Character (EQUIPMENT after POUCH, before NOTES) */
function buildDiscordChar(){
  const DIV=$("#dsDivider")?.value||"dash", FONT=$("#dsFont")?.value||"normal", COLOR=$("#dsColor")?.value||"none", FRAME=$("#dsFrame")?.value||"none";
  const divider=makeDivider(DIV), hdr=t=>colorize(fontify(frameTitle(t,FRAME),FONT),COLOR);
  const get=id=>(document.getElementById(id)?.innerText||"-").toString();

  // spells with descriptions
  const roleName=get("outRole");
  let spellsText="—";
  if(roleName==="Wizard"){
    spellsText = Object.entries(spellsArcane).map(([k,v])=>`${k}: ${v.desc} (${v.stat})`).join("\n");
  } else if(roleName==="Cleric"){
    spellsText = Object.entries(spellsHoly).map(([k,v])=>`${k}: ${v.desc} (${v.stat})`).join("\n");
  }

  const carry=(document.getElementById("equipCarryLine")?.innerText||"Carry Capacity: -").replace(/^Carry Capacity:\s*/,"");
  const warn=(document.getElementById("equipWarn")?.innerText||"").trim();
  const notes = (document.getElementById("charNotes")?.value||"").trim();

  const out=[];
  out.push(hdr("AGE OF ADVENTURE — CHARACTER SHEET")); 
  out.push(divider);

  // Identity
  out.push(hdr("IDENTITY"));
  out.push(`Name: ${get("outName")}`);
  out.push(`Community: ${get("outCommunity")}`);
  out.push(`Role: ${get("outRole")}`);
  out.push(`Homeland: ${get("outHome")}`);
  if(get("outGoal")!=="-") out.push(`Goal: ${get("outGoal")}`);
  if(get("outApp")!=="-") out.push(`Appearance: ${get("outApp")}`);
  out.push(divider);

  // Stats
  out.push(hdr("STATS"));
  out.push(`Proficiency: ${get("outProf")}`);
  out.push(`Stamina: ${get("outStamina")}`);
  out.push(`${get("outArmorNote")}`);
  const heroLine = `Hero Points: ${get("outHeroTotal")}`;
  const heroNote = get("outHeroNote");
  out.push(heroNote && heroNote!=="—" ? `${heroLine} ${heroNote}` : heroLine);
  out.push(divider);

  // Skills
  out.push(hdr("SKILLS"));
  const skl=[...document.querySelectorAll("#outSkills li")].map(li=>li.innerText);
  if(skl.length) skl.forEach(s=>out.push(`• ${s}`)); else out.push("—");
  out.push(divider);

  // Spells
  out.push(hdr("SPELLS"));
  out.push(spellsText);
  out.push(divider);

  // Pouch
  out.push(hdr("POUCH"));
  out.push(`Gold: ${get("outGold")} GP`);
  out.push(`Silver: ${get("outSilver")} SP`);
  out.push(`Other: ${get("outOther")}`);
  out.push(divider);

  // Equipment (after Pouch, before Notes)
  out.push(hdr("EQUIPMENT"));
  out.push(`Carry Capacity: ${carry}` + (warn?`  ${warn}`:""));
  numberedGearLines().forEach(l=>out.push(l));
  out.push(divider);

  // Notes
  out.push(hdr("NOTES"));
  out.push(notes?notes:"—");

  /* changed: wrap in ansi fence so colors render in Discord */
  return "```ansi\n"+out.join("\n")+"\n```";
}
async function copyDiscordChar(){ await copyText(buildDiscordChar()); }

/* ---------- Companion ---------- */
function updateAlly(){
  const sizeDefaults={ Small:{stamina:1,carry:"1#",pull:"2#",label:"Small (3 GP, 1#)"},
                       Medium:{stamina:2,carry:"3#",pull:"6#",label:"Medium (6 GP, 6#)"},
                       Large:{stamina:3,carry:"1P",pull:"2P",label:"Large (12 GP, 4P)"} };
  const sizeKey = (document.getElementById('allySize')?.value || "Small");
  const d = sizeDefaults[sizeKey];
  $("#allyStamina").value=d.stamina; $("#allyCarry").value=d.carry; $("#allyPull").value=d.pull;

  const name=($("#allyName")?.value||"-").trim(), role=($("#allyRole")?.value||"-").trim();
  const skills=($("#allySkills")?.value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const gear=($("#allyGear")?.value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const notes=($("#allyNotes")?.value||"—").trim();
  const temper=($("#allyTemper")?.value||"—").trim();

  $("#allyHeader").innerText="Animal Companion";
  $("#allyOutSize").innerText=d.label;
  $("#allyOutName").innerText=name || "-";
  $("#allyOutRole").innerText=role || "-";
  $("#allyOutStamina").innerText=$("#allyStamina").value;
  $("#allyOutCarry").innerText=$("#allyCarry").value;
  $("#allyOutPull").innerText=$("#allyPull").value;
  $("#allyOutTemper").innerText=temper || "—";
  $("#allyOutNotes").innerText=notes || "—";
  $("#allyOutSkills").innerHTML = skills.length ? skills.map(s=>`<li>${s}</li>`).join("") : "<li>—</li>";
  $("#allyOutGear").innerHTML   = gear.length   ? gear.map(s=>`<li>${s}</li>`).join("")   : "<li>—</li>";
}
function resetAlly(){
  $("#allyName").value=""; $("#allyRole").value="";
  $("#allySize").value="Small"; $("#allyStamina").value=1; $("#allyCarry").value="1#"; $("#allyPull").value="2#";
  $("#allySkills").value=""; $("#allyTemper").value=""; $("#allyGear").value=""; $("#allyNotes").value="";
  updateAlly(); route('ally');
}
function buildDiscordAlly(){
  const out=[]; out.push("```"); out.push("ANIMAL COMPANION"); out.push("────────");
  out.push(`Name: ${$("#allyOutName").innerText}`); out.push(`Type: ${$("#allyOutRole").innerText}`); out.push(`Size: ${$("#allyOutSize").innerText}`);
  out.push("────────"); out.push("STATS"); out.push(`Stamina: ${$("#allyOutStamina").innerText}`); out.push(`Carry: ${$("#allyOutCarry").innerText}`); out.push(`Pull: ${$("#allyOutPull").innerText}`);
  out.push("────────"); out.push("SKILLS"); const s=[...document.querySelectorAll("#allyOutSkills li")].map(li=>li.innerText); out.push(s.length?s.join("\n"):"—");
  out.push("────────"); out.push("TEMPERAMENT"); out.push($("#allyOutTemper").innerText||"—");
  out.push("────────"); out.push("GEAR"); const g=[...document.querySelectorAll("#allyOutGear li")].map(li=>li.innerText); out.push(g.length?g.join("\n"):"—");
  out.push("────────"); out.push("NOTES"); out.push($("#allyOutNotes").innerText || "—"); out.push("```");
  return out.join("\n");
}
async function copyDiscordAlly(){ await copyText(buildDiscordAlly()); }

/* ---------- Hireling ---------- */
function buildSkillOptions(list){
  return list.map(([name,tag])=>`<option>${name} (${tag})</option>`).join("");
}
function onHireCmmChange(){
  const v=$("#hireCmmSelect").value;
  const custom = (v==="__custom__");
  $("#hireCmmCustomLabel").classList.toggle("hidden", !custom);
  if(!custom){ $("#hireCmmSkill").value=""; }
  updateHire();
}
function onHireRoleChange(){
  const v=$("#hireRoleSelect").value;
  const custom = (v==="__custom__");
  $("#hireRoleCustomLabel").classList.toggle("hidden", !custom);
  if(!custom){ $("#hireRoleSkill").value=""; }
  updateHire();
}
function toggleHireSpell(){
  const yn=$("#hireSpellYN").value==="Yes";
  $("#hireSpellSelectLabel").classList.toggle("hidden", !yn);
  $("#hireSpellCustomLabel").classList.add("hidden");
  if(!yn){ $("#hireSpellName").value=""; }
  if(yn) populateHireSpellSelect();
}
function onHireSpellChange(){
  const v=$("#hireSpellSelect").value;
  const custom = (v==="__custom__");
  $("#hireSpellCustomLabel").classList.toggle("hidden", !custom);
  if(!custom){ $("#hireSpellName").value=""; }
  updateHire();
}
function populateHireSelectors(){
  const cmmOptions = [
    ...buildSkillOptions(skillsDB.Dwarf),
    ...buildSkillOptions(skillsDB.Elf),
    ...buildSkillOptions(skillsDB.Goblin),
    ...buildSkillOptions(skillsDB.Halfling),
    ...buildSkillOptions(skillsDB.Human),
    ...buildSkillOptions(skillsDB.Orc),
    `<option value="__custom__">Custom…</option>`
  ];
  $("#hireCmmSelect").innerHTML = `<option value="">— choose —</option>${cmmOptions.join("")}`;

  const roleOptions = [
    ...buildSkillOptions(skillsDB.Archer),
    ...buildSkillOptions(skillsDB.Barbarian),
    ...buildSkillOptions(skillsDB.Cleric),
    ...buildSkillOptions(skillsDB.Rogue),
    ...buildSkillOptions(skillsDB.Warrior),
    ...buildSkillOptions(skillsDB.Wizard),
    `<option value="__custom__">Custom…</option>`
  ];
  $("#hireRoleSelect").innerHTML = `<option value="">— choose —</option>${roleOptions.join("")}`;
}
function populateHireSpellSelect(){
  const arc = Object.entries(spellsArcane).map(([n,o])=>`<option>${n}: ${o.desc} (${o.stat})</option>`).join("");
  const hol = Object.entries(spellsHoly).map(([n,o])=>`<option>${n}: ${o.desc} (${o.stat})</option>`).join("");
  $("#hireSpellSelect").innerHTML = `<option value="">— choose —</option><optgroup label="Arcane">${arc}</optgroup><optgroup label="Holy">${hol}</optgroup><option value="__custom__">Custom…</option>`;
}

function parseNameFromTagged(s){
  if(!s) return "";
  const beforeDash = s.split("—")[0];
  const beforeColon = beforeDash.split(":")[0];
  return beforeColon.replace(/\s*\(.*?\)\s*$/,"").trim();
}

function updateHire(){
  const name=($("#hireName")?.value||"-").trim();
  const role=($("#hireRole")?.value||"-").trim();

  // Community skill
  let cmmSel=$("#hireCmmSelect")?.value||"";
  let cmmText = cmmSel ? cmmSel : "";
  if(cmmSel==="__custom__"){ cmmText = ($("#hireCmmSkill")?.value||"").trim(); }
  // Role skill
  let roleSel=$("#hireRoleSelect")?.value||"";
  let roleText = roleSel ? roleSel : "";
  if(roleSel==="__custom__"){ roleText = ($("#hireRoleSkill")?.value||"").trim(); }

  const sta=$("#hireStamina")?.value||2;
  const yn=$("#hireSpellYN")?.value||"No";

  // Spell
  let spellShown="—";
  if(yn==="Yes"){
    let spSel = $("#hireSpellSelect")?.value||"";
    if(spSel==="__custom__"){
      const custom = ($("#hireSpellName")?.value||"").trim();
      spellShown = custom || "—";
    }else if(spSel){
      const nm = parseNameFromTagged(spSel);
      let desc="";
      if(spSel.includes(":")) desc = spSel.split(":").slice(1).join(":").trim();
      spellShown = desc ? `${nm}: ${desc}` : nm;
    }
  }

  // Gear
  const gearList=($("#hireGear")?.value||"").split(",").map(s=>s.trim()).filter(Boolean);

  // Notes
  const notes = ($("#hireNotes")?.value||"").trim();

  // Output
  $("#hireOutName").innerText=name||"-";
  $("#hireOutRole").innerText=role||"-";
  $("#hireOutStamina").innerText=sta;
  $("#hireOutSkills").innerHTML = `<li>Community Skill: ${cmmText||"—"}</li><li>Role Skill: ${roleText||"—"}</li>`;
  $("#hireOutSpellYN").innerText=yn;
  $("#hireOutSpellName").innerText=(yn==="Yes" ? (spellShown||"—") : "—");
  $("#hireOutGear").innerHTML = gearList.length ? gearList.map(s=>`<li>${s}</li>`).join("") : "<li>—</li>";
  $("#hireOutNotes").innerText = notes || "—";
}

function resetHire(){
  ["hireName","hireRole","hireCmmSkill","hireRoleSkill","hireGear","hireSpellName","hireNotes"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
  $("#hireCmmSelect").selectedIndex=0; $("#hireRoleSelect").selectedIndex=0;
  $("#hireStamina").value=2; $("#hireSpellYN").value="No";
  $("#hireSpellSelectLabel").classList.add("hidden"); $("#hireSpellCustomLabel").classList.add("hidden");
  $("#hireCmmCustomLabel").classList.add("hidden"); $("#hireRoleCustomLabel").classList.add("hidden");
  updateHire(); route('hire');
}

function buildDiscordHire(){
  const out=[];
  out.push("HIRELING");
  out.push("────────");
  out.push(`Name: ${$("#hireOutName").innerText}`);
  out.push(`Role / Job: ${$("#hireOutRole").innerText}`);
  out.push("────────");
  out.push("STATS");
  out.push(`Stamina: ${$("#hireOutStamina").innerText}`);
  out.push(`Carry: 6#`);
  out.push(`Pull: 6# per 1H (–1D)`);
  out.push("────────");
  out.push("SKILLS");
  [...document.querySelectorAll("#hireOutSkills li")].forEach(li=>out.push(li.innerText));
  out.push("────────");
  out.push("MAGIC");
  out.push(`Can cast 1 spell? ${$("#hireOutSpellYN").innerText}`);
  out.push(`Spell: ${$("#hireOutSpellName").innerText}`);
  out.push("────────");
  out.push("GEAR");
  const g=[...document.querySelectorAll("#hireOutGear li")].map(li=>li.innerText);
  out.push(g.length?g.join("\n"):"—");
  out.push("────────");
  out.push("NOTES");
  out.push($("#hireOutNotes").innerText || "—");

  /* changed: wrap in ansi fence so colors render (even though this block has no color codes yet) */
  return "```ansi\n"+out.join("\n")+"\n```";
}
async function copyDiscordHire(){ await copyText(buildDiscordHire()); }

/* ---------- JSON Save/Load ---------- */
function buildState(){
  return {
    version: 3,
    route: currentRoute,
    gp, sp, heroRoll, seasonedBonus, seasonedMode,
    gear, purchaseHistory, pouchOthers,
    artefactOn, artefact,
    avatarDataURL, avatarFilename,
    char: {
      name: $("#name").value||"",
      home: $("#home").value||"",
      goal: $("#goal").value||"",
      app: $("#app").value||"",
      community: $("#community").value||"",
      role: $("#role").value||"",
      prof: $("#prof").value||"",
      customCommunityName: $("#customCommunityName").value||"",
      customCommunitySkill1: $("#customCommunitySkill1").value||"",
      customCommunitySkill2: $("#customCommunitySkill2").value||"",
      customRoleName: $("#customRoleName").value||"",
      customRoleSkill1: $("#customRoleSkill1").value||"",
      customRoleSkill2: $("#customRoleSkill2").value||"",
      extraLang: [...($("#extraLang")?.selectedOptions||[])].map(o=>o.value),
      notes: $("#charNotes").value||""
    },
    ally: {
      name: $("#allyName").value||"",
      role: $("#allyRole").value||"",
      size: $("#allySize").value||"Small",
      stamina: $("#allyStamina").value||"1",
      carry: $("#allyCarry").value||"1#",
      pull: $("#allyPull").value||"2#",
      skills: $("#allySkills").value||"",
      temper: $("#allyTemper").value||"",
      gear: $("#allyGear").value||"",
      notes: $("#allyNotes").value||""
    },
    hire: {
      name: $("#hireName").value||"",
      role: $("#hireRole").value||"",
      stamina: $("#hireStamina").value||"2",
      cmmSelect: $("#hireCmmSelect").value||"",
      cmmSkill: $("#hireCmmSkill").value||"",
      roleSelect: $("#hireRoleSelect").value||"",
      roleSkill: $("#hireRoleSkill").value||"",
      canSpell: $("#hireSpellYN").value||"No",
      spellSelect: $("#hireSpellSelect").value||"",
      spellName: $("#hireSpellName").value||"",
      gear: $("#hireGear").value||"",
      notes: $("#hireNotes").value||""
    }
  };
}

/* Download with sensible filename and stamped route */
function downloadJSONWithName(kind){
  const data = buildState();
  // Stamp route for auto-jump on load
  if(kind==='ally') data.route = 'ally';
  else if(kind==='hire') data.route = 'hire';
  else data.route = 'char-8';

  let base = 'character';
  if(kind==='ally'){
    base = (data.ally.name || data.ally.role || 'companion');
  }else if(kind==='hire'){
    base = (data.hire.name || data.hire.role || 'hireling');
  }else{
    base = (data.char.name || 'character');
  }
  const filename = `age_of_adventure_${base.toLowerCase().replace(/[^a-z0-9]+/g,'_')}.json`;

  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* wipe UI + memory before applying a loaded JSON */
function wipeForLoad(){
  gp=0; sp=0; heroRoll=0; seasonedBonus=false; seasonedMode=false;
  artefactOn=false; artefact={name:"",type:"Standard",range:"Touch (Melee/Self)",charges:"",effect:""}; lastOverCap=false;
  gear=[]; purchaseHistory=[]; pouchOthers=[];
  ["community","role","name","home","goal","app","prof","pouchOtherInput","seasonGold","customCommunityName","customCommunitySkill1","customCommunitySkill2","customRoleName","customRoleSkill1","customRoleSkill2","charNotes"].forEach(id=>{ const el=document.getElementById(id); if(el){ if(el.tagName==="SELECT") el.selectedIndex=0; else el.value=""; } });
  $("#seasonHeroPlus1Sel").value="No"; $("#seasonArtefactSel").value="No";
  $("#artefactBox").classList.add("hidden"); $("#seasonedBox").classList.add("hidden");
  $("#customCommunityBox").classList.add("hidden"); $("#customRoleBox").classList.add("hidden");
  clearAvatar();
  ["allyName","allyRole","allySkills","allyTemper","allyGear","allyNotes"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
  $("#allySize").value="Small"; $("#allyStamina").value=1; $("#allyCarry").value="1#"; $("#allyPull").value="2#";
  ["hireName","hireRole","hireCmmSkill","hireRoleSkill","hireGear","hireSpellName","hireNotes"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
  $("#hireCmmSelect").selectedIndex=0; $("#hireRoleSelect").selectedIndex=0;
  $("#hireStamina").value=2; $("#hireSpellYN").value="No";
  $("#hireSpellSelectLabel").classList.add("hidden"); $("#hireSpellCustomLabel").classList.add("hidden");
  $("#hireCmmCustomLabel").classList.add("hidden"); $("#hireRoleCustomLabel").classList.add("hidden");
}

/* Apply state and jump to correct place */
function applyState(st){
  try{
    wipeForLoad();

    gp=st.gp??gp; sp=st.sp??sp; heroRoll=st.heroRoll??heroRoll; seasonedBonus=!!st.seasonedBonus; seasonedMode=!!st.seasonedMode;
    gear=Array.isArray(st.gear)?st.gear:["Clothing","Backpack"]; purchaseHistory=Array.isArray(st.purchaseHistory)?st.purchaseHistory:[]; pouchOthers=Array.isArray(st.pouchOthers)?st.pouchOthers:[];
    artefactOn=!!st.artefactOn; artefact=st.artefact||{name:"",type:"Standard",range:"Touch (Melee/Self)",charges:"",effect:""};

    avatarDataURL=st.avatarDataURL||""; avatarFilename=st.avatarFilename||"";
    if(avatarDataURL){ $("#avatar").src=avatarDataURL; } else { clearAvatar(); }

    if(st.char){
      $("#name").value=st.char.name||""; $("#home").value=st.char.home||""; $("#goal").value=st.char.goal||"";
      $("#app").value=st.char.app||""; $("#community").value=st.char.community||""; $("#role").value=st.char.role||"";
      $("#prof").value=st.char.prof||"";
      $("#customCommunityName").value=st.char.customCommunityName||"";
      $("#customCommunitySkill1").value=st.char.customCommunitySkill1||"";
      $("#customCommunitySkill2").value=st.char.customCommunitySkill2||"";
      $("#customRoleName").value=st.char.customRoleName||"";
      $("#customRoleSkill1").value=st.char.customRoleSkill1||"";
      $("#customRoleSkill2").value=st.char.customRoleSkill2||"";
      if(st.char.community==="Human" && Array.isArray(st.char.extraLang)){
        $("#languageChoice").classList.remove("hidden");
        [...$("#extraLang").options].forEach(o=>o.selected = st.char.extraLang.includes(o.value));
      }else{
        $("#languageChoice").classList.add("hidden");
      }
      $("#charNotes").value=st.char.notes||"";
    }

    if(st.ally){
      $("#allyName").value=st.ally.name||""; $("#allyRole").value=st.ally.role||"";
      $("#allySize").value=st.ally.size||"Small"; $("#allyStamina").value=st.ally.stamina||"1";
      $("#allyCarry").value=st.ally.carry||"1#"; $("#allyPull").value=st.ally.pull||"2#";
      $("#allySkills").value=st.ally.skills||""; $("#allyTemper").value=st.ally.temper||"";
      $("#allyGear").value=st.ally.gear||""; $("#allyNotes").value=st.ally.notes||"";
    }

    if(st.hire){
      $("#hireName").value=st.hire.name||""; $("#hireRole").value=st.hire.role||"";
      $("#hireStamina").value=st.hire.stamina||"2";
      $("#hireCmmSelect").value=st.hire.cmmSelect||""; $("#hireCmmSkill").value=st.hire.cmmSkill||"";
      $("#hireRoleSelect").value=st.hire.roleSelect||""; $("#hireRoleSkill").value=st.hire.roleSkill||"";
      $("#hireSpellYN").value=st.hire.canSpell||"No";
      if(st.hire.canSpell==="Yes"){ $("#hireSpellSelectLabel").classList.remove("hidden"); populateHireSpellSelect(); }
      $("#hireSpellSelect").value=st.hire.spellSelect||""; $("#hireSpellName").value=st.hire.spellName||"";
      $("#hireGear").value=st.hire.gear||""; $("#hireNotes").value=st.hire.notes||"";
    }

    onCommunityChange(); onRoleChange(); updateWeaponHint();
    updateChar(); updateAlly(); updateHire();

    // Decide where to route:
    let dest = st.route || 'char-8';
    const hasAlly = (st.ally && (st.ally.name || st.ally.role || st.ally.skills));
    const hasHire = (st.hire && (st.hire.name || st.hire.role || st.hire.gear));
    if(hasAlly && !hasHire) dest = 'ally';
    if(hasHire && !hasAlly) dest = 'hire';
    if(dest.startsWith('char-')) dest = 'char-8';
    route(dest);

    alert("JSON loaded.");
  }catch(e){
    console.error(e);
    alert("Failed to load JSON.");
  }
}

function uploadJSON(e){
  const f = e.target.files?.[0];
  if(!f){ return; }
  const r = new FileReader();
  r.onload = ev => {
    try{
      const st = JSON.parse(ev.target.result);
      applyState(st);
    }catch(err){ console.error(err); alert("Invalid JSON file."); }
    finally{ e.target.value = ""; }
  };
  r.readAsText(f);
}

/* ---------- Init / Reset ---------- */
function resetAll(){
  gp=12+rollDice(6); sp=rollDice(6); heroRoll=rollDice(6); seasonedBonus=false; seasonedMode=false;
  artefactOn=false; artefact={name:"",type:"Standard",range:"Touch (Melee/Self)",charges:"",effect:""}; lastOverCap=false;
  gear=["Clothing","Backpack"]; purchaseHistory=[]; pouchOthers=[];
  ["community","role","name","home","goal","app","prof","pouchOtherInput","seasonGold","customCommunityName","customCommunitySkill1","customCommunitySkill2","customRoleName","customRoleSkill1","customRoleSkill2","charNotes"].forEach(id=>{ const el=document.getElementById(id); if(el){ if(el.tagName==="SELECT") el.selectedIndex=0; else el.value=""; } });
  if(document.getElementById("seasonHeroPlus1Sel")) document.getElementById("seasonHeroPlus1Sel").value="No";
  if(document.getElementById("seasonArtefactSel")) document.getElementById("seasonArtefactSel").value="No";
  $("#artefactBox").classList.add("hidden"); $("#seasonedBox").classList.add("hidden");
  $("#customCommunityBox").classList.add("hidden"); $("#customRoleBox").classList.add("hidden");
  clearAvatar();
  const r=document.querySelector('input[name="otherDest"][value="pouch"]'); if(r) r.checked=true;
  ["dsDivider","dsFont","dsColor","dsFrame"].forEach(id=>{ const el=document.getElementById(id); if(el) el.selectedIndex=0; });
  $("#wpnType").value="1H"; $("#wpnSilver").checked=false; updateWeaponHint();
  renderStore(); initShop(); populateHireSelectors(); updateChar(); updateAlly(); updateHire(); route('home');
}

function init(){
  renderStore(); initShop(); populateHireSelectors();
  gp=12+rollDice(6); sp=rollDice(6); heroRoll=rollDice(6); seasonedBonus=false; seasonedMode=false;
  gear=["Clothing","Backpack"]; purchaseHistory=[]; pouchOthers=[]; lastOverCap=false;
  updateWeaponHint(); updateChar(); updateAlly(); updateHire(); route('home');

  // Hook up home loader
  const homeInput = document.getElementById('jsonFileHome');
  if(homeInput){
    homeInput.addEventListener('change', uploadJSON);
  }
}

init();
</script>
</body>
</html>

