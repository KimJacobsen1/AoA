<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Age of Adventure – Character Creator</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500&family=EB+Garamond&display=swap" rel="stylesheet">
  <style>
    body { font-family: "EB Garamond", serif; background:#f4f0e6; margin:0; padding:20px; color:#2c2c2c; }
    h1 { text-align:center; font-size:2.6em; margin:10px 0 20px; color:#3a2c1a; font-family:"Cinzel", serif; }
    h2 { color:#3a2c1a; border-bottom:1px solid #b8a97f; padding-bottom:4px; margin-bottom:12px; font-size:1.4em; font-family:"Cinzel", serif; }
    h3, h4 { font-family:"Cinzel", serif; margin:10px 0; }
    .step { border:2px solid #b8a97f; padding:20px; margin:20px auto; border-radius:10px; background:#fffdf9; max-width:980px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    .sheet { border:2px solid #b8a97f; padding:18px 20px; margin:24px auto 40px; border-radius:12px; background:#fffef9; max-width:820px; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    .sheet h2 { text-align:center; font-size:2em; color:#3a2c1a; margin-bottom:12px; }
    .section { margin:10px 0 16px; }
    .section h4 { margin:0 0 6px; font-size:1.05em; color:#3a2c1a; }
    .hr { height:1px; background:#b8a97f; opacity:.8; border:none; margin:10px 0; }
    ul { margin:0; padding-left:20px; }
    li { margin:2px 0; }
    input, textarea, select { padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:6px; font-family:inherit; font-size:1em; width:100%; box-sizing:border-box; }
    textarea { min-height:80px; }
    .avatar-wrap { display:flex; gap:14px; align-items:flex-start; }
    .avatar { width:140px; height:140px; border:2px solid #b8a97f; border-radius:10px; object-fit:cover; background:#eee; }
    .avatar-note { font-size:.9em; color:#5a4b38; }
    .tools-grid { display:grid; grid-template-columns:1.2fr 1fr; gap:16px; }
    .tool-card { border:1px dashed #b8a97f; border-radius:10px; padding:12px; background:#fffefb; }
    .btn { margin:6px 4px; padding:10px 16px; border:none; border-radius:6px; font-size:1em; cursor:pointer; font-weight:bold; transition:transform .15s, background .25s; font-family:"Cinzel", serif; }
    .next-btn { background:#6a5234; color:#fff; } .next-btn:hover { background:#856947; transform:scale(1.05); }
    .buy-btn { background:#8b7355; color:#fff; padding:6px 12px; margin:3px; font-size:.9em; } .buy-btn:hover { background:#a18767; transform:scale(1.05); }
    .print-btn { background:#2f6d3f; color:#fff; } .print-btn:hover { background:#3f8a55; transform:scale(1.05); }
    .reset-btn { background:#7d2f2f; color:#fff; } .reset-btn:hover { background:#a14444; transform:scale(1.05); }
    .link-btn { background:#27568c; color:#fff; } .link-btn:hover { background:#2f6dad; transform:scale(1.05); }
    .choice-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:16px; }
    .choice-card { border:2px solid #b8a97f; border-radius:12px; background:#fffefb; padding:20px; text-align:center; }
    .muted { color:#6d5b3f; font-style:italic; }
    /* PRINT: only print the sheet */
    @media print {
      body { background:#fff; }
      body * { visibility:hidden !important; height:0 !important; }
      .sheet, .sheet * { visibility:visible !important; height:auto !important; }
      .sheet { position:absolute; left:0; top:0; width:100%; margin:0; border:none; box-shadow:none; }
    }
  </style>
</head>
<body>

<h1>Age of Adventure – Character Creator by Nylo</h1>

<!-- STEP 0: START CHOICE -->
<div class="step" id="step0">
  <h2>What would you like to do?</h2>
  <div class="choice-grid">
    <div class="choice-card">
      <h3>Create Character</h3>
      <p class="muted">Walk through the 8 steps, then export to PDF or copy for Discord.</p>
      <button class="btn next-btn" onclick="goto(1)">Start Character Creator</button>
    </div>
    <div class="choice-card">
      <h3>Look in the General Store</h3>
      <p class="muted">Browse all items with prices and descriptions.</p>
      <button class="btn link-btn" onclick="goto('store')">Open General Store</button>
    </div>
  </div>
</div>

<!-- GENERAL STORE -->
<div class="step" id="storeStep" style="display:none;">
  <h2>General Store</h2>
  <p class="muted">Browse items. Use the Character Creator to actually buy & add gear.</p>

  <h3>1 GP Items</h3>
  <ul id="store1"></ul>

  <h3>3 GP Items</h3>
  <ul id="store3"></ul>

  <h3>6 GP Items</h3>
  <ul id="store6"></ul>

  <p class="muted" id="storeFoot"></p>
  <div>
    <button class="btn next-btn" onclick="goto(1)">Go to Character Creator</button>
    <button class="btn reset-btn" onclick="goto(0)">Back to Start</button>
  </div>
</div>

<!-- STEP 1 -->
<div class="step" id="step1" style="display:none;">
  <h2>Step 1: Community & Role</h2>
  <label>Community:
    <select id="community" onchange="updateSheet()">
      <option value="">-- Select --</option>
      <option>Dwarf</option><option>Elf</option><option>Goblin</option>
      <option>Halfling</option><option>Human</option><option>Orc</option>
    </select>
  </label>
  <label>Role:
    <select id="role" onchange="updateSheet()">
      <option value="">-- Select --</option>
      <option>Archer</option><option>Barbarian</option><option>Cleric</option>
      <option>Rogue</option><option>Warrior</option><option>Wizard</option>
    </select>
  </label>
  <button class="btn next-btn" onclick="goto(2)">Next</button>
  <button class="btn reset-btn" onclick="goto(0)">Back</button>
</div>

<!-- STEP 2 -->
<div class="step" id="step2" style="display:none;">
  <h2>Step 2: Proficiency</h2>
  <input type="number" id="prof" min="2" max="5" onchange="updateSheet()">
  <button class="btn next-btn" onclick="goto(3)">Next</button>
  <button class="btn reset-btn" onclick="goto(1)">Back</button>
</div>

<!-- STEP 3 -->
<div class="step" id="step3" style="display:none;">
  <h2>Step 3: Name</h2>
  <input type="text" id="name" placeholder="Hero Name" oninput="updateSheet()">
  <button class="btn next-btn" onclick="goto(4)">Next</button>
  <button class="btn reset-btn" onclick="goto(2)">Back</button>
</div>

<!-- STEP 4 -->
<div class="step" id="step4" style="display:none;">
  <h2>Step 4: Homeland</h2>
  <input type="text" id="home" placeholder="Homeland" oninput="updateSheet()">
  <button class="btn next-btn" onclick="goto(5)">Next</button>
  <button class="btn reset-btn" onclick="goto(3)">Back</button>
</div>

<!-- STEP 5 -->
<div class="step" id="step5" style="display:none;">
  <h2>Step 5: Goal</h2>
  <input type="text" id="goal" placeholder="Hero Goal" oninput="updateSheet()">
  <button class="btn next-btn" onclick="goto(6)">Next</button>
  <button class="btn reset-btn" onclick="goto(4)">Back</button>
</div>

<!-- STEP 6 -->
<div class="step" id="step6" style="display:none;">
  <h2>Step 6: Appearance & Image</h2>
  <div class="avatar-wrap">
    <img id="avatar" class="avatar" alt="Character image preview">
    <div style="flex:1;">
      <textarea id="app" placeholder="Describe your hero..." oninput="updateSheet()"></textarea>
      <label class="avatar-note">Upload image (JPG/PNG/GIF):
        <input type="file" id="imgInput" accept="image/*" onchange="loadImage(event)">
      </label>
      <div><button class="btn link-btn" onclick="downloadAvatar()">Download Image</button></div>
    </div>
  </div>
  <button class="btn next-btn" onclick="goto(7)">Next</button>
  <button class="btn reset-btn" onclick="goto(5)">Back</button>
</div>

<!-- STEP 7 -->
<div class="step" id="step7" style="display:none;">
  <h2>Languages</h2>
  <p>All heroes know <strong>Common</strong>. Non-humans also know their Community tongue.
     Humans may choose <strong>two extra</strong> languages:</p>
  <div id="languageChoice" style="display:none;">
    <select id="extraLang" multiple size="6" onchange="updateSheet()">
      <option value="Dwarvish">Dwarvish</option>
      <option value="Elvish">Elvish</option>
      <option value="Goblin Tongue">Goblin Tongue</option>
      <option value="Halfling Speech">Halfling Speech</option>
      <option value="Orcish">Orcish</option>
      <option value="Other">Other</option>
    </select>
    <p><em>Hold CTRL (Windows) or CMD (Mac) to select two.</em></p>
  </div>
  <button class="btn next-btn" onclick="goto(8)">Next</button>
  <button class="btn reset-btn" onclick="goto(6)">Back</button>
</div>

<!-- STEP 8 -->
<div class="step" id="step8" style="display:none;">
  <h2>Equipment & Output</h2>
  <div class="tools-grid">
    <div class="tool-card">
      <h3>Buy Equipment</h3>
      <p><strong>Pouch:</strong> <span id="gold">-</span> GP | <span id="silver">-</span> SP</p>

      <!-- UPDATED: Other placement selector -->
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0;">
        <label style="flex:1 1 260px;">Other (eg gems; personal or mundane items)
          <input id="pouchOtherInput" type="text" placeholder="e.g., small ruby; journal; pipe">
        </label>
        <label><input type="radio" name="otherDest" value="pouch" checked> To Pouch</label>
        <label><input type="radio" name="otherDest" value="equipment"> To Equipment</label>
        <button class="btn link-btn" onclick="addOther()">Add</button>
      </div>

      <h4>1 GP Items</h4><div id="shop1"></div>
      <h4>3 GP Items</h4><div id="shop3"></div>
      <h4>6 GP Items</h4><div id="shop6"></div>
    </div>
    <div class="tool-card">
      <h3>Discord Style</h3>
      <label>Divider
        <select id="dsDivider">
          <option value="dash" selected>──────── (light)</option>
          <option value="double">════════ (double)</option>
          <option value="heavy">━━━━━━━━ (heavy)</option>
          <option value="equals">================================ (equals)</option>
        </select>
      </label><br>
      <label>Heading Font
        <select id="dsFont">
          <option value="normal" selected>Normal</option>
          <option value="bold">Bold (Unicode)</option>
          <option value="smallcaps">Small Caps (Unicode)</option>
        </select>
      </label><br>
      <label>Heading Color
        <select id="dsColor">
          <option value="none" selected>None</option>
          <option value="green">Green</option>
          <option value="blue">Blue</option>
          <option value="red">Red</option>
          <option value="yellow">Yellow</option>
          <option value="magenta">Magenta</option>
          <option value="cyan">Cyan</option>
          <option value="white">White</option>
          <option value="gray">Gray</option>
        </select>
      </label><br>
      <label>Headline Frame
        <select id="dsFrame">
          <option value="none" selected>None</option>
          <option value="brackets">[ Title ]</option>
          <option value="rounded">╭ Title ╮</option>
          <option value="heavy">┏ Title ┓</option>
          <option value="double">╔ Title ╗</option>
        </select>
      </label>
      <hr class="hr">
      <button class="btn print-btn" onclick="window.print()">Download PDF</button>
      <button class="btn next-btn" onclick="copyDiscord()">Copy for Discord</button>
      <button class="btn reset-btn" onclick="resetCreator()">Reset</button>
    </div>
  </div>
</div>

<!-- CHARACTER SHEET -->
<div class="sheet" id="characterSheet">
  <h2>Character Sheet</h2>

  <div id="sec_identity" class="section">
    <h4>Identity</h4>
    <div class="hr"></div>
    <div class="avatar-wrap" style="align-items:center;">
      <img id="avatarSheet" class="avatar" alt="Character image" style="display:none;">
      <div>
        <p><strong>Name:</strong> <span id="outName">-</span></p>
        <p><strong>Homeland:</strong> <span id="outHome">-</span></p>
        <p><strong>Community:</strong> <span id="outCommunity">-</span></p>
        <p><strong>Role:</strong> <span id="outRole">-</span></p>
        <p><strong>Goal:</strong> <span id="outGoal">-</span></p>
        <p><strong>Appearance:</strong> <span id="outApp">-</span></p>
      </div>
    </div>
  </div>

  <div id="sec_stats" class="section">
    <h4>Stats</h4>
    <div class="hr"></div>
    <p><strong>Proficiency:</strong> <span id="outProf">-</span></p>
    <p><strong>Stamina:</strong> <span id="outStamina">-</span></p>
    <p><strong>Hero Points:</strong> <span id="outHero">-</span></p>
    <p><strong>Carry Capacity:</strong> <span id="outCarry">-</span></p>
  </div>

  <div id="sec_languages" class="section">
    <h4>Languages</h4>
    <div class="hr"></div>
    <p><strong>Languages:</strong> <span id="outLang">Common</span></p>
  </div>

  <div id="sec_skills" class="section">
    <h4>Skills</h4>
    <div class="hr"></div>
    <ul id="outSkills"></ul>
  </div>

  <div id="sec_spells" class="section">
    <h4>Spells</h4>
    <div class="hr"></div>
    <div id="spellBlock"><p>—</p></div>
  </div>

  <!-- POUCH right before Equipment -->
  <div id="sec_pouch" class="section">
    <h4>Pouch</h4>
    <div class="hr"></div>
    <p><strong>Gold:</strong> <span id="outGold">-</span> GP</p>
    <p><strong>Silver:</strong> <span id="outSilver">-</span> SP</p>
    <p><strong>Other:</strong> <span id="outOther">—</span></p>
  </div>

  <div id="sec_equipment" class="section">
    <h4>Equipment</h4>
    <div class="hr"></div>
    <ul id="outGear"></ul>
  </div>
</div>

<script>
/* ===== Utilities & State ===== */
function rollDice(s){ return Math.floor(Math.random()*s)+1; }
let gp, sp, gear;
let avatarDataURL = "", avatarFilename = "";
let pouchOthers = []; // NEW: holds “Other” items that are kept in the Pouch

/* ===== Navigation ===== */
function goto(where){
  document.querySelectorAll('.step').forEach(s=>s.style.display='none');
  if(where===0){ document.getElementById('step0').style.display='block'; return; }
  if(where==='store'){ document.getElementById('storeStep').style.display='block'; return; }
  const stepEl = document.getElementById('step'+where);
  if(stepEl) stepEl.style.display='block';
  updateSheet();
}

/* ===== Data: Skills, Spells, Shop, Store Catalog ===== */
const skills = {
  Dwarf:["Detect","Teamwork"], Elf:["Acrobatics","Pathfinder"], Goblin:["Darksee","Underground"],
  Halfling:["Hide","Willpower"], Human:["Parley","Languages (+2)"], Orc:["Athletics","Resilience"],
  Archer:["Launched Weapons","1H Throw"], Barbarian:["2H Weapons","2H Throw"],
  Cleric:["Religion"], Rogue:["Sneak","Tinker"], Warrior:["1H Weapons","Unarmed"],
  Wizard:["Arcana"]
};

const spellsArcane={
  "Darksee":"Self, see in greyscale for +1D R, Far",
  "Levitate":"Self, +1R, 1 vertical Near Move per Round",
  "Missile":"Far, bolt of energy, 1 DMG",
  "Protection":"Self, -1 DMG from 1 Attack per Round (Free Action; no Spell Drain)",
  "Speak":"Self, communicate with any sentient being for +1D R",
  "Teleport":"Self, to 1 previously visited spot, Far"
};
const spellsHoly={
  "Bless":"Touch, +1D to 1 Proficiency Check next Round",
  "Divine":"Touch, reveal beyond or within 1 structure, Near",
  "Heal":"Touch, restore 1 Stamina point",
  "Light":"Touch, as if day, for +1D R, Near",
  "Smite":"Touch, Holy Weapon +1 DMG (Free Action; no Spell Drain)",
  "Ward":"Far, prevent 1 Target’s 1 Move into your Melee area within +1D R"
};

const shop={
  gp1:["Acid","Caltrops","Candles (6)","Fire Pot","Grappling Hook","Oil (6)","Pitons (6)","Provisions (6)","Rope","Small Mirror","Tinderbox","Torches (6)"],
  gp3:["Animal Companion (Small)","Armor","Heavy Armor","Arrows (6)","Cart","Lantern","Net","Bolas","Shield","Heavy Shield","Spyglass","Throwing Blades (6)","Tinker Tools","Specialist Tools","Weapon (1H/2H)","Silver Weapon"],
  gp6:["Healing Kit/Herbs (6)","Hireling","Holy Water","Magic Recharge +1","Poison","Potion","Scroll","Spellcasting Item"]
};
/* Informational catalog for General Store */
const storeCatalog = {
  gp1: [
    ["Acid","1 DMG or dissolves 1# Item e.g. Armor or a lock"],
    ["Caltrops","For Target to traverse = halves Move or 1 DMG"],
    ["Candles (6)","1-use each; lights a Melee Area, or Near in Lantern; 1 unit burns for 1 hour"],
    ["Fire Pot","1 Action to light wick; 1 Fire DMG on impact"],
    ["Grappling Hook","—"],
    ["Oil (6)","1-use each; 1 unit burns for 1 hour"],
    ["Pitons (6)","Requires a Hammer or similar Item to secure"],
    ["Provisions (6)","1 Provision/day (2 for Large)"],
    ["Rope","Far length"],
    ["Small Mirror","Also in a 3 GP Make-up Kit"],
    ["Tinderbox","—"],
    ["Torches (6)","1-use each; lights a Near Area; 1 hour burn"]
  ],
  gp3: [
    ["Animal Companion*","Small/Medium/Large with carries/pulls; Stamina 1–3"],
    ["Armor","(+1 Stamina; ½ Move to Climb & Swim) / Heavy (+1 Stamina; -1D Dodge)"],
    ["Arrows (6)","Retrieve 3/6"],
    ["Cart","Per 6# load; -1D to pull"],
    ["Lantern","Near if open; Far point if focused"],
    ["Net / Bolas","Net: 2H Throw; Medium target -1D / Bolas: 1H Throw"],
    ["Shield / Heavy Shield","Block bonus; Heavy can fully negate once/round if successful"],
    ["Spyglass","—"],
    ["Throwing Blades (6)","Retrieve 3/6"],
    ["Tinker Tools / Specialist Tools","Lock picks / pick a profession"],
    ["Weapon / Silver Weapon","1H/2H; Silver costs x2, +1 DMG vs Vulnerable, breaks 1/6"]
  ],
  gp6: [
    ["Healing Kit/Herbs (6)","Std MIND = -1 DMG; Fail still uses 1"],
    ["Hireling*","Carry 6#; pull 6#/1H -1D; Stamina 2; 1 Community + 1 Role Skill"],
    ["Holy Water","2 DMG vs Evil"],
    ["Magic Recharge +1","Recharge Artefacts"],
    ["Poison","Std Check MIGHT or Size; Fail: 1 DMG and -1D for +1D R"],
    ["Potion","Self/Touch; auto 2 Successes"],
    ["Scroll","Far; Std MIND = 2 Succ; no Drain on success/fail"],
    ["Spellcasting Item/Weapon","Unique to caster; -1D to cast without"]
  ],
  foot: "* Limit on companions/hirelings: 6 − Proficiency."
};

/* ===== Item notes for sheet display ===== */
const itemNotes = {
  "Armor":"+1 Stamina; half Move when climbing/swimming",
  "Heavy Armor":"+1 extra Stamina; -1D Dodge",
  "Shield":"Block: +1D; may negate all DMG once/round",
  "Heavy Shield":"Block: auto-negate 1 attack/round if successful",
  "Silver Weapon":"+1 DMG vs Undead/Evil; breaks on 1/6 roll",
  "Cart":"-1D penalty when pulling load",
  "Animal Companion (Small)":"Stamina 1; carry 1#; pull 2#",
  "Animal Companion (Medium)":"Stamina 2; carry 3#; pull 6#",
  "Animal Companion (Large)":"Stamina 3; carry 1P; pull 2P",
  "Hireling":"Stamina 2; carries 6#; 1 Community + 1 Role skill"
};

/* ===== General Store rendering ===== */
function renderStore(){
  const ul1 = document.getElementById('store1');
  const ul3 = document.getElementById('store3');
  const ul6 = document.getElementById('store6');
  const makeLis = arr => arr.map(([name, desc]) => `<li><strong>${name}</strong>${desc && desc!=='—' ? ` — ${desc}` : ''}</li>`).join("");
  ul1.innerHTML = makeLis(storeCatalog.gp1);
  ul3.innerHTML = makeLis(storeCatalog.gp3);
  ul6.innerHTML = makeLis(storeCatalog.gp6);
  document.getElementById('storeFoot').innerText = storeCatalog.foot;
}

/* ===== Shop (buy buttons) ===== */
function initShop(){
  makeShop("shop1",shop.gp1,1);
  makeShop("shop3",shop.gp3,3);
  makeShop("shop6",shop.gp6,6);
}
function makeShop(divID,list,cost){
  let html="";
  list.forEach(it=>{ html+=`<button class="buy-btn" onclick="buyItem('${it}',${cost})">${it} (${cost} GP)</button> `; });
  document.getElementById(divID).innerHTML=html;
}
function buyItem(name,cost){
  if(gp>=cost){ gp-=cost; gear.push(formatItem(name)); updateSheet(); }
  else if(confirm(`Not enough GP (${gp} left). Buy ${name} anyway and go into debt?`)){
    gp-=cost; gear.push(formatItem(name)); updateSheet();
  }
}
function formatItem(name){ return itemNotes[name] ? `${name} (${itemNotes[name]})` : name; }

/* ===== Numbered gear lines (0# base + purchased items) ===== */
function getNumberedGearLines(){
  const base0 = `0#: Adventurer's Clothing; Backpack; Coin Pouch (${sp} SP)`;
  const rest = (gear || []).filter(it => it !== "Clothing" && it !== "Backpack");
  return [ base0, ...rest.map((it, idx) => `${idx + 1}#: ${it}`) ];
}

/* ===== Image handling ===== */
function loadImage(evt){
  const file = evt.target.files?.[0];
  if(!file){ avatarDataURL=""; avatarFilename=""; updateSheet(); return; }
  avatarFilename = file.name || "portrait.png";
  const reader = new FileReader();
  reader.onload = e => { avatarDataURL = e.target.result; document.getElementById("avatar").src = avatarDataURL; updateSheet(); };
  reader.readAsDataURL(file);
}
function downloadAvatar(){
  if(!avatarDataURL){ alert("No image uploaded yet."); return; }
  const a = document.createElement("a");
  const safeName = (document.getElementById("outName").innerText || "character").trim().replace(/[^a-z0-9_\-]+/gi,"_") || "character";
  const ext = (avatarFilename.split(".").pop() || "png").toLowerCase();
  a.href = avatarDataURL; a.download = `${safeName}_portrait.${ext}`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

/* ===== Add “Other” logic (Pouch vs Equipment) ===== */
function addOther(){
  const input = document.getElementById('pouchOtherInput');
  const raw = (input?.value || "").trim();
  if(!raw){ alert("Type something to add."); return; }
  const dest = (document.querySelector('input[name="otherDest"]:checked')||{}).value || "pouch";
  if(dest === "equipment"){
    gear.push(raw);
  } else {
    pouchOthers.push(raw);
  }
  input.value = "";
  updateSheet();
}

/* ===== Sheet update ===== */
function updateSheet(){
  const name=document.getElementById("name")?.value||"-";
  const home=document.getElementById("home")?.value||"-";
  const goal=document.getElementById("goal")?.value||"-";
  const app=document.getElementById("app")?.value||"-";
  const comm=document.getElementById("community")?.value||"-";
  const role=document.getElementById("role")?.value||"-";
  const prof=parseInt(document.getElementById("prof")?.value)||"-";
  const stamina=(prof!="-")?prof:"-";
  const hero=(prof!="-")?rollDice(6):"-";

  // Languages
  let langs=["Common"];
  const langBox = document.getElementById("languageChoice");
  if(comm && comm !== "Human"){ langs.push(comm+" tongue"); if(langBox) langBox.style.display="none"; }
  else if(comm==="Human"){
    if(langBox) langBox.style.display="block";
    let extras=[...document.getElementById("extraLang")?.selectedOptions].map(o=>o.value);
    if(extras.length>2) extras = extras.slice(0,2);
    langs=langs.concat(extras);
  } else { if(langBox) langBox.style.display="none"; }

  // Skills
  const skillList=(skills[comm]||[]).concat(skills[role]||[]).map(s=>`<li>${s}</li>`).join("");

  // Spells
  const spellBlock=document.getElementById("spellBlock");
  if(role==="Wizard"){
    let html="<ul>"; for(let s in spellsArcane){ html+=`<li>${s}: ${spellsArcane[s]}</li>`; } html+="</ul>";
    spellBlock.innerHTML=html;
  } else if(role==="Cleric"){
    let html="<ul>"; for(let s in spellsHoly){ html+=`<li>${s}: ${spellsHoly[s]}</li>`; } html+="</ul>";
    spellBlock.innerHTML=html;
  } else { spellBlock.innerHTML="<p>—</p>"; }

  // Carry Capacity = Proficiency + 6
  const carryCap = (prof !== "-") ? (prof + 6) : "-";
  document.getElementById("outCarry").innerText = carryCap;

  // Output to sheet
  document.getElementById("outName").innerText=name;
  document.getElementById("outHome").innerText=home;
  document.getElementById("outGoal").innerText=goal;
  document.getElementById("outApp").innerText=app;
  document.getElementById("outCommunity").innerText=comm;
  document.getElementById("outRole").innerText=role;
  document.getElementById("outProf").innerText=prof;
  document.getElementById("outStamina").innerText=stamina;
  document.getElementById("outHero").innerText=hero;
  document.getElementById("outLang").innerText=langs.join(", ");
  document.getElementById("outSkills").innerHTML=skillList || "<li>—</li>";

  // Numbered equipment list on the sheet
  const numberedGear = getNumberedGearLines();
  document.getElementById("outGear").innerHTML = numberedGear.map(l => `<li>${l}</li>`).join("");

  // Pouch values (sheet + buy area)
  document.getElementById("gold").innerText=gp;
  document.getElementById("silver").innerText=sp;
  document.getElementById("outGold").innerText=gp;
  document.getElementById("outSilver").innerText=sp;
  document.getElementById("outOther").innerText=(pouchOthers.length ? pouchOthers.join("; ") : "—");

  // Image on sheet
  const avatarSheet = document.getElementById("avatarSheet");
  if(avatarDataURL){ avatarSheet.src = avatarDataURL; avatarSheet.style.display = "block"; }
  else { avatarSheet.removeAttribute("src"); avatarSheet.style.display = "none"; }
}

/* ===== Reset ===== */
function resetCreator(){
  gp=12+rollDice(6);
  sp=rollDice(6);
  gear=["Clothing","Backpack"];
  pouchOthers = []; // clear “Other” pouch entries
  const r = document.querySelector('input[name="otherDest"][value="pouch"]');
  if (r) r.checked = true;

  avatarDataURL=""; avatarFilename="";
  const avatar = document.getElementById("avatar"); if(avatar) avatar.removeAttribute("src");
  const imgInput = document.getElementById("imgInput"); if(imgInput) imgInput.value="";
  const otherInput = document.getElementById("pouchOtherInput"); if(otherInput) otherInput.value="";

  document.querySelectorAll("input, textarea, select").forEach(el=>{
    if(el.id==="imgInput" || el.id==="pouchOtherInput") return;
    if(el.type==="radio" && el.name==="otherDest") return;
    if(el.multiple) el.selectedIndex=-1; else if(el.type!=="file") el.value="";
  });
  const dd = id => document.getElementById(id);
  if(dd("dsDivider")) dd("dsDivider").value="dash";
  if(dd("dsFont"))    dd("dsFont").value="normal";
  if(dd("dsColor"))   dd("dsColor").value="none";
  if(dd("dsFrame"))   dd("dsFrame").value="none";
  goto(0);
}

/* ===== Copy for Discord (fallback-first, no counters) ===== */
async function copyText(text){
  try{
    const ta=document.createElement("textarea");
    ta.value=text; ta.setAttribute("readonly",""); ta.style.position="fixed"; ta.style.top="-1000px";
    document.body.appendChild(ta); ta.focus(); ta.select(); ta.setSelectionRange(0, ta.value.length);
    const ok=document.execCommand("copy"); document.body.removeChild(ta);
    if(navigator.clipboard && window.isSecureContext){ try{ await navigator.clipboard.writeText(text); }catch(e){} }
    alert(ok ? "Copied to clipboard!" : "Tried to copy—if it didn’t work, press Ctrl/Cmd+C.");
    return ok;
  }catch(e){ console.error(e); alert("Copy failed—press Ctrl/Cmd+C."); return false; }
}

/* Font & color helpers for Discord */
function toBold(s){ return s
  .replace(/[A-Z]/g,c=>String.fromCodePoint(c.charCodeAt(0)-0x41+0x1D400))
  .replace(/[a-z]/g,c=>String.fromCodePoint(c.charCodeAt(0)-0x61+0x1D41A))
  .replace(/[0-9]/g,d=>String.fromCodePoint(d.charCodeAt(0)-0x30+0x1D7CE)); }
const smallCapsMap={a:"ᴀ",b:"ʙ",c:"ᴄ",d:"ᴅ",e:"ᴇ",f:"ꜰ",g:"ɢ",h:"ʜ",i:"ɪ",j:"ᴊ",k:"ᴋ",l:"ʟ",m:"ᴍ",n:"ɴ",o:"ᴏ",p:"ᴘ",q:"ǫ",r:"ʀ",s:"s",t:"ᴛ",u:"ᴜ",v:"ᴠ",w:"ᴡ",x:"x",y:"ʏ",z:"ᴢ"};
function toSmallCaps(s){ return s.split("").map(ch=>smallCapsMap[ch.toLowerCase()]||ch).join(""); }
function fontify(s,mode){ if(mode==="bold") return toBold(s); if(mode==="smallcaps") return toSmallCaps(s); return s; }
const ANSI={reset:"\u001b[0m", fg:{none:"",green:"\u001b[32m",blue:"\u001b[34m",red:"\u001b[31m",yellow:"\u001b[33m",magenta:"\u001b[35m",cyan:"\u001b[36m",white:"\u001b[37m",gray:"\u001b[90m"}};
function colorize(s,c){ return c==="none" ? s : ANSI.fg[c] + s + ANSI.reset; }
function makeDivider(kind){ const w=40; if(kind==="double") return "═".repeat(w); if(kind==="heavy") return "━".repeat(w); if(kind==="equals") return "=".repeat(w); return "─".repeat(w); }
function frameTitle(txt,frame){ if(frame==="none") return txt; if(frame==="brackets") return `[ ${txt} ]`; if(frame==="rounded") return `╭ ${txt} ╮`; if(frame==="heavy") return `┏ ${txt} ┓`; if(frame==="double") return `╔ ${txt} ╗`; return txt; }

/* Build Discord text (sections always present; POUCH before EQUIPMENT; numbered gear) */
function buildDiscordBlock(){
  const DIV = (document.getElementById("dsDivider")||{}).value || "dash";
  const FONT = (document.getElementById("dsFont")||{}).value || "normal";
  const COLOR= (document.getElementById("dsColor")||{}).value || "none";
  const FRAME= (document.getElementById("dsFrame")||{}).value || "none";
  const divider = makeDivider(DIV);
  const hdr = t => colorize(fontify(frameTitle(t, FRAME), FONT), COLOR);

  const get = id => (document.getElementById(id)?.innerText || "-").toString();
  const linesOf = txt => (txt||"").trim() ? txt.trim().split("\n") : [];

  const d = {
    name:get("outName"), comm:get("outCommunity"), role:get("outRole"),
    home:get("outHome"), goal:get("outGoal"), app:get("outApp"),
    prof:get("outProf"), stam:get("outStamina"), hero:get("outHero"),
    carry:get("outCarry"), langs:get("outLang"),
    spells:linesOf(document.getElementById("spellBlock").innerText.replace(/^Arcane Spells:|^Holy Spells:/gi,"")),
    gold:get("outGold"), silver:get("outSilver"), other:get("outOther")
  };

  const out=[];
  out.push(hdr("AGE OF ADVENTURE — CHARACTER SHEET"));
  out.push(divider);

  out.push(hdr("IDENTITY"));
  out.push(`Name: ${d.name}`);
  out.push(`Community: ${d.comm}`);
  out.push(`Role: ${d.role}`);
  out.push(`Homeland: ${d.home}`);
  if(d.goal && d.goal!=="-") out.push(`Goal: ${d.goal}`);
  if(d.app  && d.app !=="-") out.push(`Appearance: ${d.app}`);
  if(avatarDataURL){
    const safe=(d.name||"character").trim().replace(/[^a-z0-9_\-]+/gi,"_")||"character";
    const ext=( (document.getElementById("imgInput")?.files?.[0]?.name || "png").split(".").pop() || "png").toLowerCase();
    out.push(`Image: ${safe}_portrait.${ext} (attach this file when posting)`);
  }
  out.push(divider);

  out.push(hdr("STATS"));
  out.push(`Proficiency: ${d.prof}`);
  out.push(`Stamina: ${d.stam}`);
  out.push(`Hero Points: ${d.hero}`);
  out.push(`Carry Capacity: ${d.carry}`);
  out.push(divider);

  out.push(hdr("LANGUAGES"));
  out.push(`Languages: ${d.langs}`);
  out.push(divider);

  out.push(hdr("SKILLS"));
  const skillsLis = Array.from(document.querySelectorAll("#outSkills li")).map(li => li.innerText);
  if(skillsLis.length) skillsLis.forEach(s=>out.push(`• ${s}`)); else out.push("—");
  out.push(divider);

  out.push(hdr("SPELLS"));
  if(d.spells.length && !(d.spells.length===1 && d.spells[0]==="—")) d.spells.forEach(s=>out.push(s)); else out.push("—");
  out.push(divider);

  out.push(hdr("POUCH"));
  out.push(`Gold: ${d.gold} GP`);
  out.push(`Silver: ${d.silver} SP`);
  out.push(`Other: ${d.other}`);
  out.push(divider);

  out.push(hdr("EQUIPMENT"));
  const gearLines = getNumberedGearLines();
  gearLines.forEach(l => out.push(l));

  const needsAnsi = COLOR!=="none";
  return (needsAnsi ? "```ansi\n" : "```\n") + out.join("\n") + "\n```";
}
async function copyDiscord(){ const block = buildDiscordBlock(); await copyText(block); }

/* ===== Init ===== */
function init(){
  renderStore();
  initShop();
  resetCreator();
}
init();
</script>

</body>
</html>



  
